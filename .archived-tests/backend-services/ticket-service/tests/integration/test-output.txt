
> tickettoken-ticket-service@1.0.0 test
> jest tests/integration/ --forceExit

FAIL tests/integration/refund-handler.test.ts (5.428 s)
  RefundHandler Integration Tests
    initiateRefund
      ✕ should update order status to REFUND_INITIATED (11 ms)
      ✕ should write refund event to outbox (13 ms)
      ✕ should include order ID in payload (16 ms)
      ✕ should include payment intent ID in payload (14 ms)
      ✕ should include refund amount in cents (15 ms)
      ✕ should include refund reason in payload (14 ms)
      ✕ should return success response (15 ms)
      ✕ should throw error if order not found (14 ms)
      ✕ should update timestamp (14 ms)
      ✕ should handle empty reason (15 ms)
      ✕ should handle long reason text (14 ms)
      ✕ should handle special characters in reason (14 ms)
      ✕ should handle refund for different order amounts (14 ms)
      ✕ should handle refund for order without payment intent (13 ms)
      ✕ should handle concurrent refund requests (14 ms)
      ✕ should handle refund already in progress (15 ms)
      ✕ should handle NULL order ID (14 ms)
      ✕ should handle undefined order ID (14 ms)
      ✕ should handle malformed order ID (13 ms)
    refund reasons
      ✕ should handle customer-initiated refund (11 ms)
      ✕ should handle event cancellation refund (12 ms)
      ✕ should handle duplicate payment refund (12 ms)
      ✕ should handle fraud-related refund (13 ms)
      ✕ should handle system error refund (12 ms)
    error handling
      ✕ should rollback on outbox write failure (13 ms)
      ✕ should handle database connection error gracefully (12 ms)
      ✕ should log error on failure (12 ms)
      ✕ should throw with descriptive error message (12 ms)
    integration with payment service
      ✕ should include all required fields for payment service (16 ms)
      ✕ should format amount correctly for payment service (14 ms)
      ✕ should preserve payment intent ID format (11 ms)
    idempotency
      ✕ should prevent duplicate refund initiations (12 ms)
      ✕ should maintain data integrity on retry (12 ms)

  ● RefundHandler Integration Tests › initiateRefund › should update order status to REFUND_INITIATED

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should write refund event to outbox

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should include order ID in payload

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should include payment intent ID in payload

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should include refund amount in cents

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should include refund reason in payload

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should return success response

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should throw error if order not found

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should update timestamp

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle empty reason

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle long reason text

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle special characters in reason

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle refund for different order amounts

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle refund for order without payment intent

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle concurrent refund requests

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle refund already in progress

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle NULL order ID

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle undefined order ID

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle malformed order ID

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle customer-initiated refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle event cancellation refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle duplicate payment refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle fraud-related refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle system error refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › error handling › should rollback on outbox write failure

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › error handling › should handle database connection error gracefully

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › error handling › should log error on failure

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › error handling › should throw with descriptive error message

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › integration with payment service › should include all required fields for payment service

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › integration with payment service › should format amount correctly for payment service

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › integration with payment service › should preserve payment intent ID format

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › idempotency › should prevent duplicate refund initiations

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › idempotency › should maintain data integrity on retry

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

FAIL tests/integration/payment-event-handler.test.ts (5.488 s)
  PaymentEventHandler Integration Tests
    handlePaymentSucceeded
      ✕ should update order status to PAID (22 ms)
      ✕ should set payment intent ID (16 ms)
      ✕ should update timestamp (16 ms)
      ✕ should queue NFT minting job (18 ms)
      ✕ should include venue ID in mint job (16 ms)
      ✕ should include quantity in mint job (16 ms)
      ✕ should write event to outbox (16 ms)
      ✕ should include payload in outbox (15 ms)
      ✕ should throw error if order not found (15 ms)
      ✕ should rollback on queue publish failure (15 ms)
      ✕ should rollback on outbox write failure (15 ms)
      ✕ should handle transaction atomically (14 ms)
      ✕ should handle concurrent payment success (14 ms)
      ✕ should include timestamp in mint job (14 ms)
      ✕ should handle order with different quantities (17 ms)
      ✕ should handle payment with special characters in ID (13 ms)
    handlePaymentFailed
      ✕ should update order status to PAYMENT_FAILED (14 ms)
      ✕ should update timestamp on failure (13 ms)
      ✕ should handle various failure reasons (14 ms)
      ✕ should handle empty reason (14 ms)
      ✕ should handle very long reason (13 ms)
      ✕ should not throw on nonexistent order (12 ms)
      ✕ should handle payment failure after success (14 ms)
      ✕ should handle concurrent failures (13 ms)
      ✕ should handle special characters in reason (12 ms)
      ✕ should preserve other order fields on failure (13 ms)
    edge cases
      ✕ should handle NULL payment ID (14 ms)
      ✕ should handle undefined order ID (14 ms)
      ✕ should handle malformed order ID (13 ms)
      ✕ should handle order without event association (13 ms)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should update order status to PAID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should set payment intent ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should update timestamp

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should queue NFT minting job

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should include venue ID in mint job

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should include quantity in mint job

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should write event to outbox

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should include payload in outbox

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should throw error if order not found

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should rollback on queue publish failure

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should rollback on outbox write failure

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should handle transaction atomically

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should handle concurrent payment success

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should include timestamp in mint job

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should handle order with different quantities

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should handle payment with special characters in ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should update order status to PAYMENT_FAILED

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should update timestamp on failure

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle various failure reasons

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle empty reason

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle very long reason

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should not throw on nonexistent order

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle payment failure after success

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle concurrent failures

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle special characters in reason

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should preserve other order fields on failure

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › edge cases › should handle NULL payment ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › edge cases › should handle undefined order ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › edge cases › should handle malformed order ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › edge cases › should handle order without event association

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

FAIL tests/integration/orders.controller.test.ts
  OrdersController Integration Tests
    getOrderById
      ✕ should return order for authenticated user (16 ms)
      ✕ should return 400 if orderId is missing (22 ms)
      ✕ should return 401 if user not authenticated (19 ms)
      ✕ should return 404 if order not found (24 ms)
      ✕ should prevent users from accessing other users orders (24 ms)
      ✕ should format prices correctly (22 ms)
    getUserOrders
      ✕ should return all orders for authenticated user (22 ms)
      ✕ should return 401 if user not authenticated (21 ms)
      ✕ should filter by status (20 ms)
      ✕ should support pagination (20 ms)
      ✕ should return empty array for user with no orders (19 ms)
    getUserTickets
      ✕ should return all tickets for authenticated user (21 ms)
      ✕ should return 401 if user not authenticated (20 ms)
      ✕ should filter by event ID (26 ms)
      ✕ should filter by status (21 ms)
      ✕ should include formatted prices (20 ms)
      ✕ should return empty array for user with no tickets (21 ms)
    security and tenant isolation
      ✕ should prevent cross-tenant order access (21 ms)
      ✕ should prevent cross-tenant ticket access (20 ms)
      ✕ should use tenant context in database queries (20 ms)
    error handling
      ✕ should handle database errors gracefully (19 ms)
      ✕ should include request ID in error responses (18 ms)
    data consistency
      ✕ should return consistent order and item data (20 ms)
      ✕ should maintain correct ticket counts (20 ms)

  ● OrdersController Integration Tests › getOrderById › should return order for authenticated user

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should return order for authenticated user

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should return 400 if orderId is missing

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should return 400 if orderId is missing

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should return 401 if user not authenticated

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should return 401 if user not authenticated

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should return 404 if order not found

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should return 404 if order not found

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should prevent users from accessing other users orders

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should prevent users from accessing other users orders

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should format prices correctly

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should format prices correctly

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should return all orders for authenticated user

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should return all orders for authenticated user

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should return 401 if user not authenticated

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should return 401 if user not authenticated

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should filter by status

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should filter by status

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should support pagination

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should support pagination

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should return empty array for user with no orders

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should return empty array for user with no orders

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should return all tickets for authenticated user

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should return all tickets for authenticated user

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should return 401 if user not authenticated

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should return 401 if user not authenticated

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should filter by event ID

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should filter by event ID

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should filter by status

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should filter by status

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should include formatted prices

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should include formatted prices

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should return empty array for user with no tickets

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should return empty array for user with no tickets

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › security and tenant isolation › should prevent cross-tenant order access

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › security and tenant isolation › should prevent cross-tenant order access

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › security and tenant isolation › should prevent cross-tenant ticket access

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › security and tenant isolation › should prevent cross-tenant ticket access

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › security and tenant isolation › should use tenant context in database queries

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › security and tenant isolation › should use tenant context in database queries

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › error handling › should handle database errors gracefully

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › error handling › should handle database errors gracefully

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › error handling › should include request ID in error responses

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › error handling › should include request ID in error responses

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › data consistency › should return consistent order and item data

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › data consistency › should return consistent order and item data

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › data consistency › should maintain correct ticket counts

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › data consistency › should maintain correct ticket counts

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

FAIL tests/integration/reservation-cleanup.worker.test.ts
  ReservationCleanupWorker Integration Tests
    worker lifecycle
      ✕ should start worker successfully (12 ms)
      ✕ should stop worker successfully (15 ms)
      ✕ should prevent multiple concurrent runs (14 ms)
      ✕ should track metrics (15 ms)
    releaseExpiredReservations
      ✕ should release expired reservations (15 ms)
      ✕ should not affect active reservations (15 ms)
      ✕ should publish expired events to outbox (15 ms)
      ✕ should clear Redis entries for expired reservations (15 ms)
      ✕ should update metrics after releasing reservations (15 ms)
    fixOrphanReservations
      ✕ should detect orphan reservations with no order (17 ms)
      ✕ should record orphan fixes in history (14 ms)
    cleanupRedisReservations
      ✕ should remove stale Redis entries (15 ms)
      ✕ should keep Redis entries for active reservations (22 ms)
      ✕ should remove Redis entries for expired reservations (16 ms)
    reconcileInventory
      ✕ should detect negative inventory (14 ms)
      ✕ should publish alerts for negative inventory (14 ms)
      ✕ should handle discrepancies between reserved and available (14 ms)
    error handling
      ✕ should handle database errors gracefully (14 ms)
      ✕ should continue running after errors (13 ms)
      ✕ should not run cleanup concurrently (14 ms)
    notifications
      ✕ should send alerts for many orphans (14 ms)
      ✕ should include metrics in notifications (15 ms)
    metrics tracking
      ✕ should track total released count (14 ms)
      ✕ should track orphans found (14 ms)
      ✕ should track orphans fixed (14 ms)
      ✕ should track errors (14 ms)
      ✕ should track last run time (15 ms)
      ✕ should increment metrics correctly (15 ms)
    integration scenarios
      ✕ should handle mixed active and expired reservations (15 ms)
      ✕ should cleanup across multiple runs (14 ms)
      ✕ should handle empty database (14 ms)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should start worker successfully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should start worker successfully

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should stop worker successfully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should stop worker successfully

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should prevent multiple concurrent runs

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should prevent multiple concurrent runs

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should track metrics

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should track metrics

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should release expired reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should release expired reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should not affect active reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should not affect active reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should publish expired events to outbox

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should publish expired events to outbox

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should clear Redis entries for expired reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should clear Redis entries for expired reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should update metrics after releasing reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should update metrics after releasing reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › fixOrphanReservations › should detect orphan reservations with no order

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › fixOrphanReservations › should detect orphan reservations with no order

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › fixOrphanReservations › should record orphan fixes in history

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › fixOrphanReservations › should record orphan fixes in history

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should remove stale Redis entries

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should remove stale Redis entries

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should keep Redis entries for active reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should keep Redis entries for active reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should remove Redis entries for expired reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should remove Redis entries for expired reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should detect negative inventory

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should detect negative inventory

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should publish alerts for negative inventory

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should publish alerts for negative inventory

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should handle discrepancies between reserved and available

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should handle discrepancies between reserved and available

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should handle database errors gracefully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should handle database errors gracefully

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should continue running after errors

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should continue running after errors

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should not run cleanup concurrently

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should not run cleanup concurrently

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › notifications › should send alerts for many orphans

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › notifications › should send alerts for many orphans

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › notifications › should include metrics in notifications

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › notifications › should include metrics in notifications

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track total released count

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track total released count

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track orphans found

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track orphans found

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track orphans fixed

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track orphans fixed

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track errors

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track errors

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track last run time

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track last run time

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should increment metrics correctly

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should increment metrics correctly

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should handle mixed active and expired reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should handle mixed active and expired reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should cleanup across multiple runs

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should cleanup across multiple runs

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should handle empty database

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should handle empty database

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

FAIL tests/integration/reservation-expiry.worker.test.ts (6.868 s)
  ReservationExpiryWorker Integration Tests
    worker lifecycle
      ✓ should start worker successfully (10 ms)
      ✓ should stop worker successfully (3 ms)
      ✓ should not start multiple instances (3 ms)
      ✓ should handle stop when not running (3 ms)
      ✓ should use custom interval (4 ms)
      ✓ should use default interval (5 ms)
    processExpiredReservations
      ✕ should expire reservations past expiry time (19 ms)
      ✕ should not expire future reservations (16 ms)
      ✕ should write expiry events to outbox (12 ms)
      ✕ should include correct payload in outbox events (12 ms)
      ✕ should process multiple expired reservations (11 ms)
      ✕ should handle reservations without order_id (13 ms)
      ✕ should run immediately on start (13 ms)
      ✓ should prevent concurrent processing (203 ms)
      ✓ should skip run if already processing (102 ms)
    stored procedure integration
      ✕ should call release_expired_reservations procedure (13 ms)
      ✕ should get count of released reservations (10 ms)
      ✕ should only process recently expired reservations for outbox (14 ms)
    error handling
      ✓ should handle database errors gracefully (202 ms)
      ✓ should continue running after errors (302 ms)
      ✓ should handle empty database (203 ms)
      ✕ should handle invalid reservation data (10 ms)
    timing and intervals
      ✓ should respect configured interval (509 ms)
      ✕ should process on each interval (19 ms)
    integration scenarios
      ✕ should handle mixed statuses (16 ms)
      ✕ should process reservations from different users (13 ms)
      ✕ should handle high volume of expirations (18 ms)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should expire reservations past expiry time

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:87:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should not expire future reservations

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:111:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should write expiry events to outbox

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:134:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should include correct payload in outbox events

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:160:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should process multiple expired reservations

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:191:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should handle reservations without order_id

    error: null value in column "ticket_type_id" of relation "reservations" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:219:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should run immediately on start

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:242:7)

  ● ReservationExpiryWorker Integration Tests › stored procedure integration › should call release_expired_reservations procedure

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:295:7)

  ● ReservationExpiryWorker Integration Tests › stored procedure integration › should get count of released reservations

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:320:7)

  ● ReservationExpiryWorker Integration Tests › stored procedure integration › should only process recently expired reservations for outbox

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:348:7)

  ● ReservationExpiryWorker Integration Tests › error handling › should handle invalid reservation data

    error: null value in column "ticket_type_id" of relation "reservations" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:422:7)

  ● ReservationExpiryWorker Integration Tests › timing and intervals › should process on each interval

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:455:7)

  ● ReservationExpiryWorker Integration Tests › integration scenarios › should handle mixed statuses

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:494:7)

  ● ReservationExpiryWorker Integration Tests › integration scenarios › should process reservations from different users

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:527:7)

  ● ReservationExpiryWorker Integration Tests › integration scenarios › should handle high volume of expirations

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:564:9)

FAIL tests/integration/qr.controller.test.ts
  QRController Integration Tests
    generateQR
      ✕ should generate QR code for ticket owner (20 ms)
      ✕ should reject non-owner access (23 ms)
      ✕ should allow admin access to any ticket (17 ms)
      ✕ should enforce tenant isolation (17 ms)
      ✕ should return QR code with 30 second expiry (17 ms)
    validateQR
      ✕ should validate valid QR code (18 ms)
      ✕ should reject invalid QR code (16 ms)
      ✕ should include validation metadata (16 ms)
    refreshQR
      ✕ should refresh QR code for ticket owner (17 ms)
      ✕ should reject non-owner refresh (16 ms)
      ✕ should allow admin to refresh any ticket (18 ms)
      ✕ should generate new QR code on refresh (15 ms)
      ✕ should enforce tenant isolation on refresh (16 ms)
    security
      ✕ should prevent access to tickets from other tenants (17 ms)
      ✕ should verify ticket ownership before operations (16 ms)
      ✕ should handle missing ticket gracefully (17 ms)
    edge cases
      ✕ should handle rapid refresh requests (16 ms)
      ✕ should handle validation with missing fields (16 ms)

  ● QRController Integration Tests › generateQR › should generate QR code for ticket owner

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should generate QR code for ticket owner

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › generateQR › should reject non-owner access

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should reject non-owner access

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › generateQR › should allow admin access to any ticket

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should allow admin access to any ticket

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › generateQR › should enforce tenant isolation

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should enforce tenant isolation

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › generateQR › should return QR code with 30 second expiry

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should return QR code with 30 second expiry

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › validateQR › should validate valid QR code

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › validateQR › should validate valid QR code

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › validateQR › should reject invalid QR code

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › validateQR › should reject invalid QR code

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › validateQR › should include validation metadata

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › validateQR › should include validation metadata

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should refresh QR code for ticket owner

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should refresh QR code for ticket owner

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should reject non-owner refresh

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should reject non-owner refresh

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should allow admin to refresh any ticket

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should allow admin to refresh any ticket

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should generate new QR code on refresh

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should generate new QR code on refresh

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should enforce tenant isolation on refresh

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should enforce tenant isolation on refresh

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › security › should prevent access to tickets from other tenants

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › security › should prevent access to tickets from other tenants

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › security › should verify ticket ownership before operations

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › security › should verify ticket ownership before operations

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › security › should handle missing ticket gracefully

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › security › should handle missing ticket gracefully

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › edge cases › should handle rapid refresh requests

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › edge cases › should handle rapid refresh requests

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › edge cases › should handle validation with missing fields

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › edge cases › should handle validation with missing fields

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

FAIL tests/integration/mintWorker.test.ts
  MintWorker Integration Tests
    processMintJob
      ✕ should successfully mint a single ticket (21 ms)
      ✕ should create ticket in database (16 ms)
      ✕ should mint multiple tickets (16 ms)
      ✕ should store NFT data in metadata (14 ms)
      ✕ should set is_nft flag to true (14 ms)
      ✕ should set is_transferable to true (14 ms)
      ✕ should generate unique ticket numbers (17 ms)
      ✕ should generate QR codes for each ticket (15 ms)
      ✕ should update order status to COMPLETED (17 ms)
      ✕ should publish order.completed event to outbox (16 ms)
      ✕ should use tenant from order if not provided (16 ms)
      ✕ should use ticketTypeId from order if not provided (15 ms)
    error handling
      ✕ should throw error for non-existent order (15 ms)
      ✕ should rollback transaction on error (15 ms)
      ✕ should set order status to MINT_FAILED on error (16 ms)
      ✕ should publish order.mint_failed event on error (16 ms)
      ✕ should handle missing ticket type gracefully (15 ms)
      ✕ should handle missing tenant gracefully (16 ms)
    NFT minting
      ✕ should generate unique NFT addresses (17 ms)
      ✕ should generate transaction signatures (15 ms)
      ✕ should include minted_at timestamp in metadata (15 ms)
    transaction handling
      ✕ should commit all changes on success (19 ms)
      ✕ should maintain atomicity (17 ms)
    edge cases
      ✕ should handle quantity of 0 (16 ms)
      ✕ should handle large quantities (16 ms)
      ✕ should set transfer_count to 0 (19 ms)
      ✕ should handle concurrent mint jobs for different orders (19 ms)

  ● MintWorker Integration Tests › processMintJob › should successfully mint a single ticket

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should create ticket in database

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should mint multiple tickets

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should store NFT data in metadata

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should set is_nft flag to true

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should set is_transferable to true

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique ticket numbers

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should generate QR codes for each ticket

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should update order status to COMPLETED

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should publish order.completed event to outbox

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should use tenant from order if not provided

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should use ticketTypeId from order if not provided

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should throw error for non-existent order

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should rollback transaction on error

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should set order status to MINT_FAILED on error

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should publish order.mint_failed event on error

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should handle missing ticket type gracefully

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should handle missing tenant gracefully

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › NFT minting › should generate unique NFT addresses

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › NFT minting › should generate transaction signatures

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › NFT minting › should include minted_at timestamp in metadata

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › transaction handling › should commit all changes on success

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › transaction handling › should maintain atomicity

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › edge cases › should handle quantity of 0

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › edge cases › should handle large quantities

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › edge cases › should set transfer_count to 0

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › edge cases › should handle concurrent mint jobs for different orders

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

FAIL tests/integration/purchase.controller.test.ts
  PurchaseController Integration Tests
    createOrder - idempotency
      ✕ should create order with valid idempotency key (13 ms)
      ✕ should return cached response for duplicate idempotency key (19 ms)
      ✕ should reject request without idempotency key (20 ms)
    createOrder - validation
      ✕ should reject request without eventId (16 ms)
      ✕ should reject request without items (17 ms)
      ✕ should reject request with empty items array (18 ms)
      ✕ should reject request without tenantId (18 ms)
    createOrder - inventory management
      ✕ should reduce available quantity when order is created (19 ms)
      ✕ should reject order when insufficient inventory (18 ms)
      ✕ should handle concurrent order attempts atomically (20 ms)
    createOrder - pricing and fees
      ✕ should calculate correct total with fees (18 ms)
      ✕ should include formatted price in response (19 ms)
      ✕ should handle multiple ticket types in one order (17 ms)
    createOrder - discount codes
      ✕ should apply valid discount code (19 ms)
      ✕ should handle invalid discount codes gracefully (17 ms)
    createOrder - tenant isolation
      ✕ should prevent cross-tenant ticket type purchases (16 ms)
      ✕ should validate all ticket types belong to same tenant (16 ms)
    createOrder - data persistence
      ✕ should create order record in database (14 ms)
      ✕ should create order items in database (16 ms)
      ✕ should set expiration time for order reservation (17 ms)
    error handling and rollback
      ✕ should rollback inventory on order creation failure (19 ms)
      ✕ should handle malformed ticket type IDs (19 ms)

  ● PurchaseController Integration Tests › createOrder - idempotency › should create order with valid idempotency key

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should create order with valid idempotency key

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should return cached response for duplicate idempotency key

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should return cached response for duplicate idempotency key

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should reject request without idempotency key

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should reject request without idempotency key

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without eventId

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without eventId

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without items

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without items

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request with empty items array

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request with empty items array

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without tenantId

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without tenantId

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should reduce available quantity when order is created

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should reduce available quantity when order is created

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should reject order when insufficient inventory

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should reject order when insufficient inventory

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should handle concurrent order attempts atomically

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should handle concurrent order attempts atomically

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should calculate correct total with fees

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should calculate correct total with fees

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should include formatted price in response

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should include formatted price in response

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should handle multiple ticket types in one order

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should handle multiple ticket types in one order

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - discount codes › should apply valid discount code

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - discount codes › should apply valid discount code

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - discount codes › should handle invalid discount codes gracefully

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - discount codes › should handle invalid discount codes gracefully

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - tenant isolation › should prevent cross-tenant ticket type purchases

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - tenant isolation › should prevent cross-tenant ticket type purchases

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - tenant isolation › should validate all ticket types belong to same tenant

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - tenant isolation › should validate all ticket types belong to same tenant

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should create order record in database

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should create order record in database

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should create order items in database

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should create order items in database

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should set expiration time for order reservation

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should set expiration time for order reservation

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › error handling and rollback › should rollback inventory on order creation failure

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › error handling and rollback › should rollback inventory on order creation failure

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › error handling and rollback › should handle malformed ticket type IDs

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › error handling and rollback › should handle malformed ticket type IDs

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

FAIL tests/integration/mint.worker.test.ts
  MintWorker Integration Tests
    processMintJob
      ✕ should successfully mint single ticket (19 ms)
      ✕ should create ticket with NFT metadata (25 ms)
      ✕ should mint multiple tickets (25 ms)
      ✕ should generate unique ticket numbers for each ticket (23 ms)
      ✕ should generate unique QR codes for each ticket (25 ms)
      ✕ should update order status to COMPLETED (31 ms)
      ✕ should create outbox event for completed order (24 ms)
      ✕ should use order data when job parameters missing (26 ms)
    error handling
      ✕ should rollback on failure (24 ms)
      ✕ should handle missing ticket type (25 ms)
      ✕ should handle missing tenant (24 ms)
      ✕ should update order to MINT_FAILED on error (23 ms)
      ✕ should create mint_failed outbox event on error (25 ms)
    transaction integrity
      ✕ should be atomic - all tickets or none (23 ms)
      ✕ should not create tickets if order update fails (25 ms)
    NFT minting
      ✕ should generate unique NFT addresses (25 ms)
      ✕ should generate transaction signatures (27 ms)
      ✕ should include NFT metadata in ticket (23 ms)
    data consistency
      ✕ should maintain referential integrity (26 ms)
      ✕ should set correct ticket properties (26 ms)
      ✕ should set purchased_at timestamp (25 ms)
    edge cases
      ✕ should handle zero quantity jobs (31 ms)
      ✕ should handle large batch minting (33 ms)

  ● MintWorker Integration Tests › processMintJob › should successfully mint single ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should successfully mint single ticket

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should create ticket with NFT metadata

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should create ticket with NFT metadata

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should mint multiple tickets

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should mint multiple tickets

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique ticket numbers for each ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique ticket numbers for each ticket

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique QR codes for each ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique QR codes for each ticket

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should update order status to COMPLETED

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should update order status to COMPLETED

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should create outbox event for completed order

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should create outbox event for completed order

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should use order data when job parameters missing

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should use order data when job parameters missing

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should rollback on failure

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should rollback on failure

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should handle missing ticket type

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should handle missing ticket type

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should handle missing tenant

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should handle missing tenant

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should update order to MINT_FAILED on error

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should update order to MINT_FAILED on error

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should create mint_failed outbox event on error

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should create mint_failed outbox event on error

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › transaction integrity › should be atomic - all tickets or none

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › transaction integrity › should be atomic - all tickets or none

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › transaction integrity › should not create tickets if order update fails

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › transaction integrity › should not create tickets if order update fails

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › NFT minting › should generate unique NFT addresses

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › NFT minting › should generate unique NFT addresses

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › NFT minting › should generate transaction signatures

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › NFT minting › should generate transaction signatures

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › NFT minting › should include NFT metadata in ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › NFT minting › should include NFT metadata in ticket

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › data consistency › should maintain referential integrity

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › data consistency › should maintain referential integrity

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › data consistency › should set correct ticket properties

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › data consistency › should set correct ticket properties

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › data consistency › should set purchased_at timestamp

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › data consistency › should set purchased_at timestamp

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › edge cases › should handle zero quantity jobs

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › edge cases › should handle zero quantity jobs

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › edge cases › should handle large batch minting

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › edge cases › should handle large batch minting

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

FAIL tests/integration/transfer.controller.test.ts
  TransferController Integration Tests
    transferTicket
      ✕ should successfully transfer ticket from owner to recipient (10 ms)
      ✕ should create transfer record in database (17 ms)
      ✕ should record transfer with optional reason (18 ms)
      ✕ should prevent unauthorized transfer (15 ms)
      ✕ should prevent transfer of non-existent ticket (16 ms)
      ✕ should prevent transfer to same user (18 ms)
      ✕ should log audit trail for successful transfer (20 ms)
      ✕ should log audit trail for failed transfer attempt (18 ms)
    getTransferHistory
      ✕ should return transfer history for a ticket (17 ms)
      ✕ should return empty array for ticket with no transfers (16 ms)
      ✕ should return transfers in chronological order (18 ms)
      ✕ should include transfer metadata (16 ms)
    validateTransfer
      ✕ should validate transfer from owner (16 ms)
      ✕ should reject validation from non-owner (17 ms)
      ✕ should reject validation for non-existent ticket (27 ms)
      ✕ should reject validation for self-transfer (26 ms)
      ✕ should reject validation for used tickets (17 ms)
      ✕ should include validation reason in response (18 ms)
    security and tenant isolation
      ✕ should prevent cross-tenant transfer access (23 ms)
      ✕ should validate ticket ownership before transfer (20 ms)
    edge cases
      ✕ should handle rapid transfer attempts (16 ms)
      ✕ should handle transfer with missing toUserId (19 ms)
      ✕ should handle transfer with missing ticketId (20 ms)
    data consistency
      ✕ should maintain referential integrity during transfer (16 ms)
      ✕ should preserve ticket metadata during transfer (16 ms)

  ● TransferController Integration Tests › transferTicket › should successfully transfer ticket from owner to recipient

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should successfully transfer ticket from owner to recipient

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should create transfer record in database

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should create transfer record in database

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should record transfer with optional reason

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should record transfer with optional reason

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should prevent unauthorized transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should prevent unauthorized transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should prevent transfer of non-existent ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should prevent transfer of non-existent ticket

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should prevent transfer to same user

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should prevent transfer to same user

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should log audit trail for successful transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should log audit trail for successful transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should log audit trail for failed transfer attempt

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should log audit trail for failed transfer attempt

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › getTransferHistory › should return transfer history for a ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › getTransferHistory › should return transfer history for a ticket

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › getTransferHistory › should return empty array for ticket with no transfers

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › getTransferHistory › should return empty array for ticket with no transfers

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › getTransferHistory › should return transfers in chronological order

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › getTransferHistory › should return transfers in chronological order

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › getTransferHistory › should include transfer metadata

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › getTransferHistory › should include transfer metadata

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should validate transfer from owner

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should validate transfer from owner

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation from non-owner

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation from non-owner

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for non-existent ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for non-existent ticket

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for self-transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for self-transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for used tickets

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for used tickets

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should include validation reason in response

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should include validation reason in response

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › security and tenant isolation › should prevent cross-tenant transfer access

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › security and tenant isolation › should prevent cross-tenant transfer access

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › security and tenant isolation › should validate ticket ownership before transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › security and tenant isolation › should validate ticket ownership before transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › edge cases › should handle rapid transfer attempts

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › edge cases › should handle rapid transfer attempts

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › edge cases › should handle transfer with missing toUserId

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › edge cases › should handle transfer with missing toUserId

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › edge cases › should handle transfer with missing ticketId

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › edge cases › should handle transfer with missing ticketId

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › data consistency › should maintain referential integrity during transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › data consistency › should maintain referential integrity during transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › data consistency › should preserve ticket metadata during transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › data consistency › should preserve ticket metadata during transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

FAIL tests/integration/purchase-saga.test.ts
  PurchaseSaga Integration Tests
    successful purchase flow
      ✕ should complete all 3 steps successfully (13 ms)
      ✕ should reserve inventory atomically (10 ms)
      ✕ should create order via order service (12 ms)
      ✕ should create tickets in database (11 ms)
      ✕ should handle multiple item types (13 ms)
      ✕ should pass idempotency key to order service (12 ms)
      ✕ should include tenant in order metadata (12 ms)
      ✕ should pass discount codes to order service (10 ms)
    inventory management
      ✕ should fail if insufficient inventory (11 ms)
      ✕ should not modify inventory on insufficient stock (11 ms)
      ✕ should handle concurrent purchases correctly (13 ms)
      ✕ should update reserved_quantity correctly (11 ms)
    compensation - step 2 failure (order service)
      ✕ should release inventory if order creation fails (11 ms)
      ✕ should not create tickets if order fails (14 ms)
      ✕ should handle OrderServiceError specifically (12 ms)
    compensation - step 3 failure (ticket creation)
      ✕ should cancel order if ticket creation fails (11 ms)
      ✕ should release inventory if ticket creation fails (12 ms)
    transaction atomicity
      ✕ should rollback all changes on failure (13 ms)
      ✕ should maintain consistency across all operations (12 ms)
    edge cases
      ✕ should handle zero quantity gracefully (12 ms)
      ✕ should handle non-existent ticket type (12 ms)
      ✕ should handle empty items array (14 ms)
      ✕ should enforce tenant isolation (15 ms)
      ✕ should handle large quantities (13 ms)

  ● PurchaseSaga Integration Tests › successful purchase flow › should complete all 3 steps successfully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should reserve inventory atomically

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should create order via order service

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should create tickets in database

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should handle multiple item types

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should pass idempotency key to order service

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should include tenant in order metadata

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should pass discount codes to order service

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › inventory management › should fail if insufficient inventory

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › inventory management › should not modify inventory on insufficient stock

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › inventory management › should handle concurrent purchases correctly

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › inventory management › should update reserved_quantity correctly

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 2 failure (order service) › should release inventory if order creation fails

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 2 failure (order service) › should not create tickets if order fails

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 2 failure (order service) › should handle OrderServiceError specifically

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 3 failure (ticket creation) › should cancel order if ticket creation fails

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 3 failure (ticket creation) › should release inventory if ticket creation fails

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › transaction atomicity › should rollback all changes on failure

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › transaction atomicity › should maintain consistency across all operations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should handle zero quantity gracefully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should handle non-existent ticket type

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should handle empty items array

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should enforce tenant isolation

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should handle large quantities

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

FAIL tests/integration/transfer.service.test.ts
  TransferService Integration Tests
    transferTicket
      ✕ should successfully transfer ticket (3 ms)
      ✕ should update ticket ownership (10 ms)
      ✕ should create transfer record (9 ms)
      ✕ should reject transfer from non-owner (8 ms)
      ✕ should reject transfer for incorrect status (8 ms)
      ✕ should reject transfer when event disallows transfers (9 ms)
      ✕ should reject transfer past deadline (10 ms)
      ✕ should enforce max transfer limit (10 ms)
      ✕ should transfer without reason parameter (10 ms)
    validateTransferRequest
      ✕ should validate successful transfer (10 ms)
      ✕ should reject self-transfer (10 ms)
      ✕ should reject transfer to inactive user (9 ms)
      ✕ should reject transfer to unverified email (10 ms)
      ✕ should reject transfer when recipient cannot receive (9 ms)
      ✕ should reject non-transferable ticket (9 ms)
      ✕ should reject locked ticket (9 ms)
      ✕ should reject transfer for non-existent ticket (10 ms)
      ✕ should reject transfer to non-existent user (8 ms)
    getTransferHistory
      ✕ should return empty history for untransferred ticket (8 ms)
      ✕ should return transfer history after transfer (13 ms)
      ✕ should return multiple transfers in order (8 ms)
    transfer cooldown
      ✕ should enforce cooldown period between transfers (9 ms)
    rate limiting
      ✕ should enforce daily transfer limit (8 ms)
    blackout periods
      ✕ should reject transfers during blackout (8 ms)
    identity verification
      ✕ should require identity verification when enabled (7 ms)
      ✕ should allow transfer when both users verified (7 ms)
    edge cases
      ✕ should handle missing venue transfer deadline (9 ms)
      ✕ should handle ticket without transfer_history (10 ms)

  ● TransferService Integration Tests › transferTicket › should successfully transfer ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should update ticket ownership

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should create transfer record

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should reject transfer from non-owner

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should reject transfer for incorrect status

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should reject transfer when event disallows transfers

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should reject transfer past deadline

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should enforce max transfer limit

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should transfer without reason parameter

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should validate successful transfer

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject self-transfer

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer to inactive user

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer to unverified email

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer when recipient cannot receive

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject non-transferable ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject locked ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer for non-existent ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer to non-existent user

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › getTransferHistory › should return empty history for untransferred ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › getTransferHistory › should return transfer history after transfer

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › getTransferHistory › should return multiple transfers in order

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transfer cooldown › should enforce cooldown period between transfers

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › rate limiting › should enforce daily transfer limit

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › blackout periods › should reject transfers during blackout

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › identity verification › should require identity verification when enabled

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › identity verification › should allow transfer when both users verified

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › edge cases › should handle missing venue transfer deadline

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › edge cases › should handle ticket without transfer_history

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

FAIL tests/integration/qr.service.test.ts
  QRService Integration Tests
    generateRotatingQR
      ✕ should generate QR code for valid ticket (4 ms)
      ✕ should generate different QR codes over time (11 ms)
      ✕ should throw error for non-existent ticket (10 ms)
      ✕ should store validation data in Redis (9 ms)
      ✕ should generate QR image with correct dimensions (10 ms)
    validateQR
      ✕ should successfully validate fresh QR code (9 ms)
      ✕ should reject already used ticket (10 ms)
      ✕ should reject QR for wrong event (8 ms)
      ✕ should reject invalid QR format (9 ms)
      ✕ should reject expired QR code (10 ms)
      ✕ should create validation record in database (9 ms)
      ✕ should update ticket status to USED (10 ms)
      ✕ should clear ticket cache after validation (9 ms)
    encryption and decryption
      ✕ should encrypt and decrypt QR data (9 ms)
      ✕ should handle corrupted encrypted data (7 ms)
      ✕ should generate unique nonces for each QR (7 ms)
    concurrent validation prevention
      ✕ should prevent double validation with row locking (9 ms)
    edge cases
      ✕ should handle ticket with no seat information (8 ms)
      ✕ should handle validation without optional fields (9 ms)
      ✕ should reject validation for reserved ticket (9 ms)
      ✕ should reject validation for cancelled ticket (8 ms)
    QR image generation
      ✕ should generate base64 PNG image (8 ms)
      ✕ should generate scannable QR image (8 ms)
    Redis failure handling
      ✕ should generate QR even if Redis is unavailable (8 ms)
      ✕ should validate QR even if Redis cache clear fails (16 ms)
    validation data integrity
      ✕ should store complete validation information (9 ms)

  ● QRService Integration Tests › generateRotatingQR › should generate QR code for valid ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › generateRotatingQR › should generate different QR codes over time

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › generateRotatingQR › should throw error for non-existent ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › generateRotatingQR › should store validation data in Redis

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › generateRotatingQR › should generate QR image with correct dimensions

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should successfully validate fresh QR code

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should reject already used ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should reject QR for wrong event

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should reject invalid QR format

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should reject expired QR code

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should create validation record in database

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should update ticket status to USED

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should clear ticket cache after validation

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › encryption and decryption › should encrypt and decrypt QR data

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › encryption and decryption › should handle corrupted encrypted data

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › encryption and decryption › should generate unique nonces for each QR

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › concurrent validation prevention › should prevent double validation with row locking

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › edge cases › should handle ticket with no seat information

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › edge cases › should handle validation without optional fields

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › edge cases › should reject validation for reserved ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › edge cases › should reject validation for cancelled ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › QR image generation › should generate base64 PNG image

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › QR image generation › should generate scannable QR image

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › Redis failure handling › should generate QR even if Redis is unavailable

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › Redis failure handling › should validate QR even if Redis cache clear fails

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validation data integrity › should store complete validation information

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

FAIL tests/integration/discount.service.test.ts
  DiscountService Integration Tests
    applyDiscounts
      ✓ should apply percentage discount correctly (11 ms)
      ✓ should return original amount when no discount codes provided (3 ms)
      ✓ should handle fixed amount discount (7 ms)
      ✓ should handle BOGO discount (25% off) (12 ms)
      ✓ should respect minimum purchase requirement (11 ms)
      ✓ should respect maximum discount limit (10 ms)
      ✓ should stack multiple discounts when allowed (12 ms)
      ✓ should not stack non-stackable discounts (11 ms)
      ✓ should respect discount priority order (9 ms)
      ✓ should handle expired discounts (6 ms)
      ✓ should handle discounts not yet valid (13 ms)
      ✓ should record discount usage (6 ms)
      ✓ should respect max uses limit (6 ms)
      ✓ should handle invalid discount codes gracefully (3 ms)
      ✓ should not apply discount below $0 (9 ms)
      ✓ should handle early_bird discount type (9 ms)
    validateDiscountCode
      ✓ should validate active discount code (5 ms)
      ✓ should reject invalid discount code (3 ms)
      ✓ should reject expired discount (5 ms)
      ✓ should reject not yet active discount (6 ms)
      ✓ should reject discount at usage limit (7 ms)
      ✕ should validate event-specific discount (14 ms)

  ● DiscountService Integration Tests › validateDiscountCode › should validate event-specific discount

    error: insert or update on table "discounts" violates foreign key constraint "discounts_event_id_fkey"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/discount.service.test.ts:358:29)

  console.log
    ✓ Test setup: JWT private key loaded

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Redis connected for distributed locks

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:inventory:[CARD]-[CARD]:61f9d035-abc9-4cb7-92aa-13b88c7bdb1d (9ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:inventory:[CARD]-[CARD]:61f9d035-abc9-4cb7-92aa-13b88c7bdb1d (held for 19ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:inventory:[CARD]-[CARD]:03514d30-0c7b-4bf1-ba77-3c69e7222c78 (0ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:inventory:[CARD]-[CARD]:03514d30-0c7b-4bf1-ba77-3c69e7222c78 (held for 7ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:inventory:[CARD]-[CARD]:d763c643-f9da-4717-910e-93fb763ebe42 (1ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:inventory:[CARD]-[CARD]:d763c643-f9da-4717-910e-93fb763ebe42 (held for 6ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:inventory:[CARD]-[CARD]:7562637b-a805-4e25-ab39-85cb991572a0 (0ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:inventory:[CARD]-[CARD]:7562637b-a805-4e25-ab39-85cb991572a0 (held for 3ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:inventory:[CARD]-[CARD]:20b9474c-c397-4198-9412-ed7f3da9d26f (1ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:inventory:[CARD]-[CARD]:20b9474c-c397-4198-9412-ed7f3da9d26f (held for 6ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:a278b331-1e1b-4511-9190-ade903c2722e (1ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:a278b331-1e1b-4511-9190-ade903c2722e (held for 9ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:18b36a23-3aec-48c7-809c-093e8f068a5b (1ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:18b36a23-3aec-48c7-809c-093e8f068a5b (held for 9ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:67959afa-443f-4c72-b9ec-7342f12c535d (1ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:67959afa-443f-4c72-b9ec-7342f12c535d (held for 3ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:9369bb98-7e49-44d7-8b67-262ef06ddced (1ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:9369bb98-7e49-44d7-8b67-262ef06ddced (held for 4ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:78331d88-e36f-4bc0-9937-dcad7b4b3e91 (0ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:78331d88-e36f-4bc0-9937-dcad7b4b3e91 (held for 8ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:beff4277-0c33-43da-8716-9093ae3dd2b6 (0ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:beff4277-0c33-43da-8716-9093ae3dd2b6 (held for 5ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:e7b72501-9999-4a4c-a6c9-dcea62c057e6 (1ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:e7b72501-9999-4a4c-a6c9-dcea62c057e6 (held for 6ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:7abc4f96-16aa-457a-8c1c-86a8067f6333 (0ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:7abc4f96-16aa-457a-8c1c-86a8067f6333 (held for 2ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:c61ef4f6-24ef-437f-8a82-2772ef2391d1 (0ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:c61ef4f6-24ef-437f-8a82-2772ef2391d1 (held for 2ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock acquired: test:lock:reservation:5443adb4-9d62-4473-bdd0-74b93c4d2686 (0ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Lock released: test:lock:reservation:5443adb4-9d62-4473-bdd0-74b93c4d2686 (held for 3ms)

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

  console.log
    Circuit test-circuit attempting recovery (HALF_OPEN)

      at CircuitBreaker.call (src/utils/CircuitBreaker.ts:60:15)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

PASS tests/integration/redis.service.test.ts
  RedisService Integration Tests
    initialize()
      ✓ should initialize Redis connection (13 ms)
      ✓ should return same client instance (singleton) (1 ms)
    get/set operations
      ✓ should set and get a value (5 ms)
      ✓ should return null for non-existent key (2 ms)
      ✓ should set value with TTL (1104 ms)
      ✓ should overwrite existing value (2 ms)
      ✓ should handle empty string values (2 ms)
      ✓ should handle JSON string values (2 ms)
    del operation
      ✓ should delete existing key (3 ms)
      ✓ should not throw error when deleting non-existent key (1 ms)
    exists operation
      ✓ should return true for existing key (2 ms)
      ✓ should return false for non-existent key (1 ms)
    incr operation
      ✓ should increment non-existent key to 1 (2 ms)
      ✓ should increment existing counter (2 ms)
      ✓ should increment multiple times (2 ms)
    expire operation
      ✓ should set expiration on existing key (1104 ms)
    mget operation
      ✓ should get multiple values (3 ms)
      ✓ should return null for missing keys in mget (2 ms)
      ✓ should handle empty array (1 ms)
    mset operation
      ✓ should set multiple values (3 ms)
      ✓ should handle empty array
      ✓ should overwrite existing keys (3 ms)
    isHealthy()
      ✓ should return true when Redis is healthy
    special characters and edge cases
      ✓ should handle keys with colons (1 ms)
      ✓ should handle values with special characters (1 ms)
      ✓ should handle unicode values (1 ms)
      ✓ should handle very long keys (2 ms)
      ✓ should handle very long values (1 ms)
    concurrent operations
      ✓ should handle concurrent sets (5 ms)
      ✓ should handle concurrent increments (1 ms)
    race conditions
      ✓ should handle rapid set/get cycles (14 ms)
      ✓ should handle set/delete/set pattern (2 ms)
    TTL behavior
      ✓ should respect TTL ordering (1104 ms)
    data types
      ✓ should store numeric strings (3 ms)
      ✓ should store boolean strings (2 ms)

PASS tests/integration/ticket.service.test.ts
  TicketService
    createTicketType
      ✓ should create a ticket type with valid data (37 ms)
      ✓ should store price correctly from cents (15 ms)
      ✓ should set default metadata to empty object (14 ms)
    getTicketTypes
      ✓ should return all ticket types for an event (18 ms)
      ✓ should return ticket types ordered by price ascending (17 ms)
      ✓ should return empty array for event with no ticket types (10 ms)
      ✓ should not return ticket types from other tenants (12 ms)
    checkAvailability
      ✓ should return true when enough tickets available (12 ms)
      ✓ should return false when not enough tickets available (12 ms)
      ✓ should return true when requesting exact available quantity (12 ms)
      ✓ should throw NotFoundError for non-existent ticket type (25 ms)
    getTicket
      ✓ should return ticket by id (20 ms)
      ✓ should include ticket type name in result (18 ms)
      ✓ should throw NotFoundError for non-existent ticket (12 ms)
      ✓ should enforce tenant isolation when tenantId provided (18 ms)
    getUserTickets
      ✓ should return all tickets for a user (17 ms)
      ✓ should filter by event when eventId provided (17 ms)
      ✓ should return empty array for user with no tickets (18 ms)
      ✓ should order tickets by created_at descending (67 ms)
    updateTicketStatus
      ✓ should update ticket status to used (15 ms)
      ✓ should update ticket status to cancelled (15 ms)
      ✓ should update updated_at timestamp (66 ms)
    getTicketType
      ✓ should return ticket type by id (13 ms)
      ✓ should return null for non-existent ticket type (12 ms)
      ✓ should enforce tenant isolation (11 ms)
    updateTicketType
      ✓ should update ticket type name (13 ms)
      ✓ should update ticket type price from cents (13 ms)
      ✓ should update multiple fields at once (12 ms)
      ✓ should throw NotFoundError for non-existent ticket type (11 ms)
      ✓ should enforce tenant isolation (12 ms)
    createReservation
      ✓ should create a reservation with valid data (33 ms)
      ✓ should decrement available_quantity on ticket type (20 ms)
      ✓ should set expiration time on reservation (21 ms)
      ✓ should throw ConflictError when not enough tickets available (20 ms)
      ✓ should throw NotFoundError for non-existent ticket type (18 ms)
    confirmPurchase
      ✓ should confirm reservation and create tickets (25 ms)
      ✓ should update reservation status to confirmed (44 ms)
      ✓ should throw NotFoundError for non-existent reservation (22 ms)
      ✓ should throw ConflictError for already confirmed reservation (22 ms)
      ✓ should generate unique ticket numbers for each ticket (26 ms)
    releaseReservation
      ✓ should release reservation and restore availability (22 ms)
      ✓ should update reservation status to cancelled (23 ms)
      ✓ should throw NotFoundError for non-existent reservation (15 ms)
      ✓ should throw NotFoundError if user does not own reservation (16 ms)
      ✓ should throw NotFoundError for already processed reservation (18 ms)
    generateQR
      ✓ should generate QR code data for valid ticket (524 ms)
      ✓ should generate base64 QR image (508 ms)
      ✓ should throw NotFoundError for non-existent ticket (14 ms)
    validateQR
      ✓ should validate QR code for active ticket (508 ms)
      ✓ should return invalid for used ticket (489 ms)
      ✓ should return invalid for malformed QR data (15 ms)
      ✓ should handle base64 encoded QR format (17 ms)

  console.log
    Circuit test-circuit attempting recovery (HALF_OPEN)

      at CircuitBreaker.call (src/utils/CircuitBreaker.ts:60:15)

  console.log
    ✅ Circuit test-circuit recovered (CLOSED)

      at CircuitBreaker.onSuccess (src/utils/CircuitBreaker.ts:101:17)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

  console.error
    Test error

      48 | console.error = (...args: any[]) => {
      49 |   const sanitized = args.map(arg => PIISanitizer.sanitize(arg));
    > 50 |   originalConsoleError(...sanitized);
         |   ^
      51 | };
      52 |
      53 | console.warn = (...args: any[]) => {

      at console.Object.<anonymous>.console.error (src/utils/logger.ts:50:3)
      at Object.<anonymous> (tests/integration/logger.util.test.ts:316:15)

  console.warn
    Test warning

      53 | console.warn = (...args: any[]) => {
      54 |   const sanitized = args.map(arg => PIISanitizer.sanitize(arg));
    > 55 |   originalConsoleWarn(...sanitized);
         |   ^
      56 | };
      57 |
      58 | // Helper functions

      at console.Object.<anonymous>.console.warn (src/utils/logger.ts:55:3)
      at Object.<anonymous> (tests/integration/logger.util.test.ts:323:15)

  console.log
    ✓ Running database service integration tests against test database: tickettoken_db

      at console.Object.<anonymous>.console.log (src/utils/logger.ts:45:3)

PASS tests/integration/logger.util.test.ts
  Logger Utility Integration Tests
    logger instance
      ✓ should be a winston logger instance (1 ms)
      ✓ should have default service metadata (1 ms)
      ✓ should log info messages (1 ms)
      ✓ should log error messages
      ✓ should log warn messages (1 ms)
      ✓ should log debug messages (1 ms)
      ✓ should log with additional metadata (1 ms)
      ✓ should log errors with stack traces (1 ms)
      ✓ should log objects
      ✓ should log arrays (1 ms)
      ✓ should handle null values
      ✓ should handle undefined values (1 ms)
    createLogger
      ✓ should create a child logger
      ✓ should create child logger with component metadata (1 ms)
      ✓ should create multiple child loggers
      ✓ should allow child logger to log all levels (1 ms)
    logError helper
      ✓ should log errors with message (1 ms)
      ✓ should log errors with metadata
      ✓ should log errors with stack traces (1 ms)
      ✓ should handle error objects with custom properties
      ✓ should handle non-Error objects (1 ms)
      ✓ should handle string errors
    logRequest helper
      ✓ should log request objects (1 ms)
      ✓ should log requests with metadata
      ✓ should log requests with various HTTP methods (1 ms)
      ✓ should log requests with query parameters
      ✓ should log requests with headers
      ✓ should sanitize sensitive data in requests
    PII Sanitization
      ✓ should sanitize email addresses in logs (1 ms)
      ✓ should sanitize credit card numbers
      ✓ should sanitize passwords (1 ms)
      ✓ should sanitize SSN
      ✓ should sanitize phone numbers (1 ms)
      ✓ should sanitize nested PII data
    Console override
      ✓ should sanitize console.log output (1 ms)
      ✓ should sanitize console.error output (31 ms)
      ✓ should sanitize console.warn output (3 ms)
      ✓ should handle multiple arguments in console methods (1 ms)
    Error handling
      ✓ should handle logging failures gracefully
      ✓ should handle very large log objects (46 ms)
      ✓ should handle special characters in messages (1 ms)

PASS tests/integration/auth.middleware.test.ts
  Auth Middleware Integration Tests
    authenticate
      missing token
        ✓ should return 401 when no authorization header (1 ms)
        ✓ should return 401 when authorization header is empty
        ✓ should return 401 when authorization header does not start with Bearer (1 ms)
        ✓ should return 401 when Bearer prefix but no token
      invalid token
        ✓ should return 401 for invalid token (1 ms)
        ✓ should return 401 for malformed token
      expired token
        ✓ should return 401 for expired token (1 ms)
      valid token
        ✓ should attach user to request for valid token
        ✓ should extract userId from decoded token (1 ms)
        ✓ should extract tenantId from decoded token
        ✓ should handle token with id instead of userId
        ✓ should handle token with sub instead of userId (1 ms)
        ✓ should handle token with tenant_id instead of tenantId
        ✓ should not call reply.status for valid token
        ✓ should preserve all token data in user object (1 ms)
      error handling
        ✓ should return 500 for unexpected errors (1 ms)
    requireRole
      no user
        ✓ should throw UnauthorizedError when no user (9 ms)
      role-based access
        ✓ should allow access when user has required role
        ✓ should allow access when user role is in allowed roles list
        ✓ should return 403 when user does not have required role (1 ms)
        ✓ should return 403 for empty role
        ✓ should return 403 for null role (1 ms)
      admin permissions
        ✓ should allow access for admin:all permission (1 ms)
        ✓ should allow admin:all even without matching role
      venue manager permissions
        ✓ should allow venue_manager role with venue: permissions (1 ms)
        ✓ should allow with single venue: permission
        ✓ should return 403 for venue_manager without venue: permissions
      multiple roles
        ✓ should allow access with first matching role
        ✓ should allow access with last matching role
        ✓ should return 403 when role not in list (1 ms)
      edge cases
        ✓ should handle empty roles array
        ✓ should handle undefined permissions
        ✓ should handle null permissions (1 ms)
        ✓ should handle empty permissions array
        ✓ should be case-sensitive for roles (1 ms)
        ✓ should be case-sensitive for permissions
    integration scenarios
      ✓ should authenticate and authorize in sequence (1 ms)
      ✓ should fail authorization without authentication (6 ms)
      ✓ should handle multiple authorization checks (1 ms)

PASS tests/integration/database.service.test.ts
  DatabaseService Integration Tests
    getPool()
      ✓ should return a valid PostgreSQL pool (3 ms)
      ✓ should return the same pool instance (singleton) (1 ms)
    query execution
      ✓ should execute a simple SELECT query (1 ms)
      ✓ should execute CREATE TABLE statement (16 ms)
      ✓ should execute INSERT with parameters (9 ms)
      ✓ should execute UPDATE with parameters (9 ms)
      ✓ should execute DELETE with parameters (9 ms)
      ✓ should handle parameterized queries safely (SQL injection prevention) (11 ms)
    transaction support
      ✓ should support transactions with commit (9 ms)
      ✓ should support transactions with rollback (8 ms)
      ✓ should rollback on error within transaction (9 ms)
    connection pool management
      ✓ should acquire and release connections (1 ms)
      ✓ should handle multiple concurrent connections (11 ms)
      ✓ should reuse connections from pool (1 ms)
    error handling
      ✓ should throw error for invalid SQL syntax (11 ms)
      ✓ should throw error for non-existent table (1 ms)
      ✓ should throw error for constraint violations (24 ms)
      ✓ should provide meaningful error messages (11 ms)
    data type handling
      ✓ should handle INTEGER types correctly (15 ms)
      ✓ should handle VARCHAR types correctly (16 ms)
      ✓ should handle BOOLEAN types correctly (11 ms)
      ✓ should handle TIMESTAMP types correctly (8 ms)
      ✓ should handle NULL values correctly (8 ms)
      ✓ should handle JSONB types correctly (10 ms)
    performance and limits
      ✓ should handle large result sets (236 ms)
      ✓ should handle long strings (13 ms)
    connection health
      ✓ should verify database is reachable (1 ms)
      ✓ should get current database name (1 ms)
      ✓ should get database version (1 ms)

PASS tests/integration/validation.util.test.ts
  Validation Utility Integration Tests
    ticketSchemas.purchaseTickets
      ✓ should validate valid purchase request (2 ms)
      ✓ should require eventId (2 ms)
      ✓ should require tickets array
      ✓ should reject empty tickets array
      ✓ should require ticketTypeId in each ticket (1 ms)
      ✓ should require quantity in each ticket
      ✓ should reject quantity less than 1
      ✓ should reject quantity greater than 10 (1 ms)
      ✓ should accept optional seatNumbers (1 ms)
      ✓ should accept optional metadata (1 ms)
    ticketSchemas.createTicketType
      ✓ should validate valid ticket type (2 ms)
      ✓ should require name
      ✓ should reject name longer than 100 characters (1 ms)
      ✓ should accept optional description
      ✓ should reject negative price
      ✓ should accept zero price for free tickets
      ✓ should require saleEndDate after saleStartDate
      ✓ should reject maxPerPurchase greater than 10 (1 ms)
    ticketSchemas.transferTicket
      ✓ should validate valid transfer request
      ✓ should require ticketId (1 ms)
      ✓ should require toUserId
      ✓ should accept optional reason
      ✓ should reject reason longer than 200 characters
      ✓ should require UUID format for ticketId (1 ms)
      ✓ should require UUID format for toUserId
    ticketSchemas.validateQR
      ✓ should validate valid QR validation request
      ✓ should require qrCode
      ✓ should require eventId (1 ms)
      ✓ should accept optional entrance
      ✓ should accept optional deviceId
    validate middleware
      ✓ should create validation middleware function
      ✓ should pass validation for valid data (1 ms)
      ✓ should return 400 for invalid data (1 ms)
      ✓ should include validation error details

PASS tests/integration/config/index.test.ts
  Config Integration Tests
    environment configuration
      ✓ should load config object (1 ms)
      ✓ should have env property (1 ms)
      ✓ should have port property
    database configuration
      ✓ should have database config (1 ms)
      ✓ should have pool configuration
      ✓ should have timeout settings (1 ms)
    redis configuration
      ✓ should have redis URL
      ✓ should have TTL settings (1 ms)
    rabbitmq configuration
      ✓ should have rabbitmq URL (1 ms)
      ✓ should have queue names
    solana configuration
      ✓ should have solana RPC URL (1 ms)
      ✓ should have commitment level
    service URLs configuration
      ✓ should have all service URLs (1 ms)
      ✓ should have valid URL format
    JWT configuration
      ✓ should have JWT secret (1 ms)
    QR configuration
      ✓ should have QR settings
      ✓ should have minimum encryption key length (1 ms)
    limits configuration
      ✓ should have all limit settings
      ✓ should have reasonable limit values (1 ms)
    AWS configuration
      ✓ should have AWS settings
      ✓ should have valid AWS region format
    feature flags
      ✓ should have features object (1 ms)
      ✓ should have useOrderService flag
    additional settings
      ✓ should have service timeout
      ✓ should have internal service secret
    config immutability
      ✓ should not allow modification of config
    environment-specific config
      ✓ should load development config
      ✓ should load test config
    config structure validation
      ✓ should have all top-level keys (1 ms)
      ✓ should have correct types for all values (1 ms)

PASS tests/integration/errors.test.ts
  Error Classes Integration Tests
    AppError
      ✓ should create error with message and status code (1 ms)
      ✓ should create error with code (1 ms)
      ✓ should default to 500 status code
      ✓ should capture stack trace (12 ms)
      ✓ should be throwable (1 ms)
      ✓ should be catchable as Error
    ValidationError
      ✓ should create validation error with 400 status
      ✓ should be throwable (1 ms)
      ✓ should inherit from AppError
    NotFoundError
      ✓ should create not found error with 404 status (1 ms)
      ✓ should format message with resource name
      ✓ should be throwable (1 ms)
    ConflictError
      ✓ should create conflict error with 409 status
      ✓ should be throwable (1 ms)
    UnauthorizedError
      ✓ should create unauthorized error with 401 status
      ✓ should accept custom message (1 ms)
      ✓ should be throwable
    ForbiddenError
      ✓ should create forbidden error with 403 status (1 ms)
      ✓ should accept custom message
      ✓ should be throwable (1 ms)
    TooManyRequestsError
      ✓ should create rate limit error with 429 status
      ✓ should accept custom message
      ✓ should be throwable (1 ms)
    error inheritance chain
      ✓ should maintain proper inheritance for ValidationError
      ✓ should maintain proper inheritance for NotFoundError
      ✓ should maintain proper inheritance for ConflictError (6 ms)
      ✓ should maintain proper inheritance for UnauthorizedError
      ✓ should maintain proper inheritance for ForbiddenError (1 ms)
      ✓ should maintain proper inheritance for TooManyRequestsError
    error catching by type
      ✓ should catch specific error type
      ✓ should catch as AppError
      ✓ should catch as generic Error
    error serialization
      ✓ should serialize AppError properties
      ✓ should include stack in JSON stringify
    error with different scenarios
      ✓ should handle empty message (1 ms)
      ✓ should handle very long messages
      ✓ should handle special characters in message
      ✓ should handle unicode in message (1 ms)
    error comparison
      ✓ should differentiate between error types
      ✓ should compare status codes (1 ms)

PASS tests/integration/tax.service.test.ts
  TaxService Integration Tests
    calculateOrderTax
      ✓ should calculate tax for California (1 ms)
      ✓ should calculate tax for New York
      ✓ should calculate tax for Texas (1 ms)
      ✓ should calculate tax for states with no sales tax
      ✓ should calculate tax for Oregon (no sales tax)
      ✓ should calculate tax for Montana (no sales tax)
      ✓ should handle small amounts correctly
      ✓ should handle large amounts correctly (6 ms)
      ✓ should provide breakdown for California (2 ms)
      ✓ should have null local breakdown for states without local tax
      ✓ should calculate tax for Illinois
      ✓ should calculate tax for Tennessee (1 ms)
      ✓ should handle unknown state as zero tax
      ✓ should round fractional cents correctly
      ✓ should calculate tax for all 50 states (12 ms)
      ✓ should have consistent cent calculations (no float errors)
      ✓ should handle zero amount (1 ms)
      ✓ should calculate tax for Washington
      ✓ should calculate tax for Massachusetts
      ✓ should calculate tax for Pennsylvania
      ✓ should calculate tax for New Jersey
      ✓ should calculate tax for Mississippi (1 ms)
      ✓ should calculate tax for Rhode Island
      ✓ should calculate tax for Indiana
      ✓ should use integer math throughout calculation (2 ms)
      ✓ should handle case-sensitive state codes
      ✓ should provide complete breakdown structure (1 ms)
      ✓ should calculate combined rate correctly for all local tax states

PASS tests/integration/queue-listener.test.ts
  QueueListener Integration Tests
    message consumption
      ✓ should consume messages from queue (1 ms)
      ✓ should handle multiple messages
      ✓ should acknowledge processed messages
      ✓ should handle message processing errors
      ✓ should retry failed messages (1 ms)
    dead letter queue
      ✓ should route unprocessable messages to DLQ
      ✓ should preserve message metadata in DLQ
    consumer patterns
      ✓ should handle concurrent message consumers
      ✓ should maintain message order when required (1 ms)
    message timeout handling
      ✓ should timeout long-running message processing
      ✓ should not timeout fast messages
    queue metrics
      ✓ should track message processing rate (1 ms)
      ✓ should count successful message deliveries
      ✓ should count failed message deliveries

FAIL tests/integration/ticket.controller.test.ts
  ● Test suite failed to run

    [96mtests/integration/ticket.controller.test.ts[0m:[93m53[0m:[93m17[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m53[0m     await cache.clear();
    [7m  [0m [91m                ~~~~~[0m

FAIL tests/integration/tenant.middleware.test.ts
  ● Test suite failed to run

    [96mtests/integration/tenant.middleware.test.ts[0m:[93m314[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ headers: { 'x-tenant-id': string; }; tenantId: undefined; }' is not assignable to parameter of type 'FastifyRequest<RouteGenericInterface, RawServerDefault, IncomingMessage, FastifySchema, FastifyTypeProviderDefault, unknown, FastifyBaseLogger, ResolveFastifyRequestType<...>>'.
      Type '{ headers: { 'x-tenant-id': string; }; tenantId: undefined; }' is missing the following properties from type 'FastifyRequest<RouteGenericInterface, RawServerDefault, IncomingMessage, FastifySchema, FastifyTypeProviderDefault, unknown, FastifyBaseLogger, ResolveFastifyRequestType<...>>': id, params, raw, query, and 21 more.

    [7m314[0m         await tenantMiddleware(req, mockReply);
    [7m   [0m [91m                               ~~~[0m
    [96mtests/integration/tenant.middleware.test.ts[0m:[93m324[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ headers: { 'x-tenant-id': string; }; tenantId: undefined; }' is not assignable to parameter of type 'FastifyRequest<RouteGenericInterface, RawServerDefault, IncomingMessage, FastifySchema, FastifyTypeProviderDefault, unknown, FastifyBaseLogger, ResolveFastifyRequestType<...>>'.
      Type '{ headers: { 'x-tenant-id': string; }; tenantId: undefined; }' is missing the following properties from type 'FastifyRequest<RouteGenericInterface, RawServerDefault, IncomingMessage, FastifySchema, FastifyTypeProviderDefault, unknown, FastifyBaseLogger, ResolveFastifyRequestType<...>>': id, params, raw, query, and 21 more.

    [7m324[0m         await tenantMiddleware(req, mockReply);
    [7m   [0m [91m                               ~~~[0m

FAIL tests/integration/solana.service.test.ts
  ● Test suite failed to run

    [96mtests/integration/solana.service.test.ts[0m:[93m54[0m:[93m50[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; description: string; }; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; description: string; }; }' but required in type 'NFTMintRequest'.

    [7m54[0m       const result = await SolanaService.mintNFT(request);
    [7m  [0m [91m                                                 ~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m78[0m:[93m51[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' but required in type 'NFTMintRequest'.

    [7m78[0m       const result1 = await SolanaService.mintNFT(request1);
    [7m  [0m [91m                                                  ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m80[0m:[93m51[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' but required in type 'NFTMintRequest'.

    [7m80[0m       const result2 = await SolanaService.mintNFT(request2);
    [7m  [0m [91m                                                  ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m103[0m:[93m50[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; description: string; image: string; attributes: { trait_type: string; value: string; }[]; }; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; description: string; image: string; attributes: { trait_type: string; value: string; }[]; }; }' but required in type 'NFTMintRequest'.

    [7m103[0m       const result = await SolanaService.mintNFT(request);
    [7m   [0m [91m                                                 ~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m118[0m:[93m51[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' but required in type 'NFTMintRequest'.

    [7m118[0m         requests.map(req => SolanaService.mintNFT(req))
    [7m   [0m [91m                                                  ~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m207[0m:[93m50[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' but required in type 'NFTMintRequest'.

    [7m207[0m       const result = await SolanaService.mintNFT(request);
    [7m   [0m [91m                                                 ~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m226[0m:[93m9[0m - [91merror[0m[90m TS2740: [0mType '{}' is missing the following properties from type '{ eventId: string; eventName: string; venueName: string; eventDate: string; ticketType: string; seatInfo?: string | undefined; imageUrl: string; }': eventId, eventName, venueName, eventDate, and 2 more.

    [7m226[0m         metadata: {}
    [7m   [0m [91m        ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m178[0m:[93m3[0m
        [7m178[0m   metadata: {
        [7m   [0m [96m  ~~~~~~~~[0m
        The expected type comes from property 'metadata' which is declared here on type 'NFTMintRequest'
    [96mtests/integration/solana.service.test.ts[0m:[93m249[0m:[93m9[0m - [91merror[0m[90m TS2740: [0mType '{}' is missing the following properties from type '{ eventId: string; eventName: string; venueName: string; eventDate: string; ticketType: string; seatInfo?: string | undefined; imageUrl: string; }': eventId, eventName, venueName, eventDate, and 2 more.

    [7m249[0m         metadata: {}
    [7m   [0m [91m        ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m178[0m:[93m3[0m
        [7m178[0m   metadata: {
        [7m   [0m [96m  ~~~~~~~~[0m
        The expected type comes from property 'metadata' which is declared here on type 'NFTMintRequest'
    [96mtests/integration/solana.service.test.ts[0m:[93m278[0m:[93m11[0m - [91merror[0m[90m TS2740: [0mType '{}' is missing the following properties from type '{ eventId: string; eventName: string; venueName: string; eventDate: string; ticketType: string; seatInfo?: string | undefined; imageUrl: string; }': eventId, eventName, venueName, eventDate, and 2 more.

    [7m278[0m           metadata: {}
    [7m   [0m [91m          ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m178[0m:[93m3[0m
        [7m178[0m   metadata: {
        [7m   [0m [96m  ~~~~~~~~[0m
        The expected type comes from property 'metadata' which is declared here on type 'NFTMintRequest'
    [96mtests/integration/solana.service.test.ts[0m:[93m313[0m:[93m50[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; symbol: string; description: string; seller_fee_basis_points: number; image: string; external_url: string; attributes: { ...; }[]; properties: { ...; }; }; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; symbol: string; description: string; seller_fee_basis_points: number; image: string; external_url: string; attributes: { ...; }[]; properties: { ...; }; }; }' but required in type 'NFTMintRequest'.

    [7m313[0m       const result = await SolanaService.mintNFT(request);
    [7m   [0m [91m                                                 ~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.

FAIL tests/integration/inter-service-client.test.ts
  ● Test suite failed to run

    [96mtests/integration/inter-service-client.test.ts[0m:[93m3[0m:[93m25[0m - [91merror[0m[90m TS2307: [0mCannot find module 'axios-mock-adapter' or its corresponding type declarations.

    [7m3[0m import MockAdapter from 'axios-mock-adapter';
    [7m [0m [91m                        ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/inter-service-client.test.ts[0m:[93m139[0m:[93m37[0m - [91merror[0m[90m TS7006: [0mParameter 'config' implicitly has an 'any' type.

    [7m139[0m       mock.onGet(/\/headers/).reply(config => {
    [7m   [0m [91m                                    ~~~~~~[0m
    [96mtests/integration/inter-service-client.test.ts[0m:[93m332[0m:[93m35[0m - [91merror[0m[90m TS7006: [0mParameter 'config' implicitly has an 'any' type.

    [7m332[0m       mock.onGet(/\/trace/).reply(config => {
    [7m   [0m [91m                                  ~~~~~~[0m
    [96mtests/integration/inter-service-client.test.ts[0m:[93m465[0m:[93m35[0m - [91merror[0m[90m TS7006: [0mParameter 'config' implicitly has an 'any' type.

    [7m465[0m       mock.onPost(/\/json/).reply(config => {
    [7m   [0m [91m                                  ~~~~~~[0m

FAIL tests/integration/rate-limit.middleware.test.ts
  ● Test suite failed to run

    [96mtests/integration/rate-limit.middleware.test.ts[0m:[93m485[0m:[93m15[0m - [91merror[0m[90m TS7022: [0m'rep' implicitly has type 'any' because it does not have a type annotation and is referenced directly or indirectly in its own initializer.

    [7m485[0m         const rep = {
    [7m   [0m [91m              ~~~[0m
    [96mtests/integration/rate-limit.middleware.test.ts[0m:[93m487[0m:[93m45[0m - [91merror[0m[90m TS2448: [0mBlock-scoped variable 'rep' used before its declaration.

    [7m487[0m           header: jest.fn().mockReturnValue(rep),
    [7m   [0m [91m                                            ~~~[0m

      [96mtests/integration/rate-limit.middleware.test.ts[0m:[93m485[0m:[93m15[0m
        [7m485[0m         const rep = {
        [7m   [0m [96m              ~~~[0m
        'rep' is declared here.

  console.log
    Circuit test-circuit attempting recovery (HALF_OPEN)

      at CircuitBreaker.call (src/utils/CircuitBreaker.ts:60:15)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

FAIL tests/integration/error-handler.middleware.test.ts
  ● Test suite failed to run

    [96mtests/integration/error-handler.middleware.test.ts[0m:[93m2[0m:[93m50[0m - [91merror[0m[90m TS2305: [0mModule '"../../src/utils/errors"' has no exported member 'BadRequestError'.

    [7m2[0m import { AppError, NotFoundError, ConflictError, BadRequestError, UnauthorizedError } from '../../src/utils/errors';
    [7m [0m [91m                                                 ~~~~~~~~~~~~~~~[0m

FAIL tests/integration/cache-integration.test.ts
  ● Test suite failed to run

    [96mtests/integration/cache-integration.test.ts[0m:[93m25[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m25[0m       expect(cache.del).toBeDefined();
    [7m  [0m [91m                   ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m26[0m:[93m27[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m26[0m       expect(typeof cache.del).toBe('function');
    [7m  [0m [91m                          ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m30[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m30[0m       expect(cache.clear).toBeDefined();
    [7m  [0m [91m                   ~~~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m31[0m:[93m27[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m31[0m       expect(typeof cache.clear).toBe('function');
    [7m  [0m [91m                          ~~~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m38[0m:[93m43[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m38[0m       await cache.set(testKey, testValue, 60);
    [7m  [0m [91m                                          ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m44[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m44[0m       await cache.del(testKey);
    [7m  [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m56[0m:[93m46[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m56[0m       await cache.set(testKey, complexValue, 60);
    [7m  [0m [91m                                             ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m62[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m62[0m       await cache.del(testKey);
    [7m  [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m73[0m:[93m41[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m73[0m       await cache.set(testKey, 'value', 60);
    [7m  [0m [91m                                        ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m77[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m77[0m       await cache.del(testKey);
    [7m  [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m85[0m:[93m43[0m - [91merror[0m[90m TS2559: [0mType '1' has no properties in common with type 'CacheOptions'.

    [7m85[0m       await cache.set(testKey, 'expires', 1);
    [7m  [0m [91m                                          ~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m99[0m:[93m42[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m99[0m       await cache.set(keys[0], 'value1', 60);
    [7m  [0m [91m                                         ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m100[0m:[93m42[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m100[0m       await cache.set(keys[1], 'value2', 60);
    [7m   [0m [91m                                         ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m101[0m:[93m42[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m101[0m       await cache.set(keys[2], 'value3', 60);
    [7m   [0m [91m                                         ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m112[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m112[0m       await cache.del(keys[0]);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m113[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m113[0m       await cache.del(keys[1]);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m114[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m114[0m       await cache.del(keys[2]);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m120[0m:[93m36[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m120[0m       await cache.set(testKey, '', 60);
    [7m   [0m [91m                                   ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m126[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m126[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m132[0m:[93m39[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m132[0m       await cache.set(testKey, 12345, 60);
    [7m   [0m [91m                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m138[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m138[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m145[0m:[93m39[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m145[0m       await cache.set(testKey1, true, 60);
    [7m   [0m [91m                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m146[0m:[93m40[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m146[0m       await cache.set(testKey2, false, 60);
    [7m   [0m [91m                                       ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m155[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m155[0m       await cache.del(testKey1);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m156[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m156[0m       await cache.del(testKey2);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m163[0m:[93m44[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m163[0m       await cache.set(testKey, arrayValue, 60);
    [7m   [0m [91m                                           ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m169[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m169[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m210[0m:[93m43[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m210[0m       await cache.set(testKey, testValue, 60);
    [7m   [0m [91m                                          ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m216[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m216[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m224[0m:[93m44[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m224[0m       await cache.set(testKey, 'isolated', 60);
    [7m   [0m [91m                                           ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m230[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m230[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m238[0m:[93m78[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m238[0m         operations.push(cache.set(`test:cache:concurrent:${i}`, `value${i}`, 60));
    [7m   [0m [91m                                                                             ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m252[0m:[93m31[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m252[0m         cleanupOps.push(cache.del(`test:cache:concurrent:${i}`));
    [7m   [0m [91m                              ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m259[0m:[93m52[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m259[0m       await cache.set(testKey, 'concurrent value', 60);
    [7m   [0m [91m                                                   ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m273[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m273[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m280[0m:[93m45[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m280[0m         cache.set(`${baseKey}:1`, 'value1', 60),
    [7m   [0m [91m                                            ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m281[0m:[93m45[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m281[0m         cache.set(`${baseKey}:2`, 'value2', 60),
    [7m   [0m [91m                                            ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m283[0m:[93m45[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m283[0m         cache.set(`${baseKey}:3`, 'value3', 60),
    [7m   [0m [91m                                            ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m303[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m303[0m       await cache.del(`${baseKey}:1`);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m304[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m304[0m       await cache.del(`${baseKey}:2`);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m305[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m305[0m       await cache.del(`${baseKey}:3`);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m318[0m:[93m38[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m318[0m       await cache.set(testKey, null, 60);
    [7m   [0m [91m                                     ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m324[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m324[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m330[0m:[93m43[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m330[0m       await cache.set(testKey, undefined, 60);
    [7m   [0m [91m                                          ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m337[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m337[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m344[0m:[93m55[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m344[0m       await cache.set('test:cache:clear:1', 'value1', 60);
    [7m   [0m [91m                                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m345[0m:[93m55[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m345[0m       await cache.set('test:cache:clear:2', 'value2', 60);
    [7m   [0m [91m                                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m346[0m:[93m55[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m346[0m       await cache.set('test:cache:clear:3', 'value3', 60);
    [7m   [0m [91m                                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m349[0m:[93m17[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m349[0m       if (cache.clear) {
    [7m   [0m [91m                ~~~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m350[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m350[0m         await cache.clear('test:cache:clear:*');
    [7m   [0m [91m                    ~~~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m353[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m353[0m         await cache.del('test:cache:clear:1');
    [7m   [0m [91m                    ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m354[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m354[0m         await cache.del('test:cache:clear:2');
    [7m   [0m [91m                    ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m355[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m355[0m         await cache.del('test:cache:clear:3');
    [7m   [0m [91m                    ~~~[0m

FAIL tests/integration/async-handler.util.test.ts
  ● Test suite failed to run

    [96mtests/integration/async-handler.util.test.ts[0m:[93m23[0m:[93m62[0m - [91merror[0m[90m TS2345: [0mArgument of type '(code?: number) => never' is not assignable to parameter of type '(code?: string | number | null | undefined) => never'.
      Types of parameters 'code' and 'code' are incompatible.
        Type 'string | number | null | undefined' is not assignable to type 'number | undefined'.
          Type 'null' is not assignable to type 'number | undefined'.

    [7m23[0m     exitSpy = jest.spyOn(process, 'exit').mockImplementation((code?: number) => {
    [7m  [0m [91m                                                             ~~~~~~~~~~~~~~~~~~~~[0m

FAIL tests/integration/Transfer.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Transfer.model.test.ts[0m:[93m18[0m:[93m39[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m18[0m     transferModel = new TransferModel(DatabaseService.pool);
    [7m  [0m [91m                                      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Transfer.model.test.ts[0m:[93m18[0m:[93m55[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m18[0m     transferModel = new TransferModel(DatabaseService.pool);
    [7m  [0m [91m                                                      ~~~~[0m

FAIL tests/integration/Ticket.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Ticket.model.test.ts[0m:[93m18[0m:[93m35[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m18[0m     ticketModel = new TicketModel(DatabaseService.pool);
    [7m  [0m [91m                                  ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Ticket.model.test.ts[0m:[93m18[0m:[93m51[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m18[0m     ticketModel = new TicketModel(DatabaseService.pool);
    [7m  [0m [91m                                                  ~~~~[0m

FAIL tests/integration/Reservation.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Reservation.model.test.ts[0m:[93m19[0m:[93m45[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m19[0m     reservationModel = new ReservationModel(DatabaseService.pool);
    [7m  [0m [91m                                            ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Reservation.model.test.ts[0m:[93m19[0m:[93m61[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m19[0m     reservationModel = new ReservationModel(DatabaseService.pool);
    [7m  [0m [91m                                                            ~~~~[0m
    [96mtests/integration/Reservation.model.test.ts[0m:[93m238[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m238[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'
    [96mtests/integration/Reservation.model.test.ts[0m:[93m251[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m251[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'
    [96mtests/integration/Reservation.model.test.ts[0m:[93m280[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m280[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'
    [96mtests/integration/Reservation.model.test.ts[0m:[93m403[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m403[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'
    [96mtests/integration/Reservation.model.test.ts[0m:[93m416[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m416[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'

FAIL tests/integration/QRCode.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/QRCode.model.test.ts[0m:[93m17[0m:[93m35[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m17[0m     qrCodeModel = new QRCodeModel(DatabaseService.pool);
    [7m  [0m [91m                                  ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/QRCode.model.test.ts[0m:[93m17[0m:[93m51[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m17[0m     qrCodeModel = new QRCodeModel(DatabaseService.pool);
    [7m  [0m [91m                                                  ~~~~[0m

FAIL tests/integration/Order.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Order.model.test.ts[0m:[93m17[0m:[93m33[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m17[0m     orderModel = new OrderModel(DatabaseService.pool);
    [7m  [0m [91m                                ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Order.model.test.ts[0m:[93m17[0m:[93m49[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m17[0m     orderModel = new OrderModel(DatabaseService.pool);
    [7m  [0m [91m                                                ~~~~[0m

FAIL tests/integration/Purchase.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Purchase.model.test.ts[0m:[93m18[0m:[93m39[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m18[0m     purchaseModel = new PurchaseModel(DatabaseService.pool);
    [7m  [0m [91m                                      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Purchase.model.test.ts[0m:[93m18[0m:[93m55[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m18[0m     purchaseModel = new PurchaseModel(DatabaseService.pool);
    [7m  [0m [91m                                                      ~~~~[0m

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

  console.log
    Circuit test-circuit manually reset

      at CircuitBreaker.reset (src/utils/CircuitBreaker.ts:133:13)

  console.log
    Circuit test-circuit manually reset

      at CircuitBreaker.reset (src/utils/CircuitBreaker.ts:133:13)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

  console.log
    Circuit test-circuit manually reset

      at CircuitBreaker.reset (src/utils/CircuitBreaker.ts:133:13)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

  console.log
    ⚠️ Circuit test-circuit opened due to failures

      at CircuitBreaker.onFailure (src/utils/CircuitBreaker.ts:115:15)

  console.log
    Circuit test-circuit attempting recovery (HALF_OPEN)

      at CircuitBreaker.call (src/utils/CircuitBreaker.ts:60:15)

  console.log
    ✅ Circuit test-circuit recovered (CLOSED)

      at CircuitBreaker.onSuccess (src/utils/CircuitBreaker.ts:101:17)

PASS tests/integration/CircuitBreaker.test.ts (10.605 s)
  CircuitBreaker Integration Tests
    initialization
      ✓ should initialize with default options (1 ms)
      ✓ should initialize with custom options
      ✓ should start in CLOSED state (1 ms)
    successful calls
      ✓ should execute successful async function (1 ms)
      ✓ should track successful calls in statistics
      ✓ should reset failure count on success (1 ms)
      ✓ should pass arguments to the function (1 ms)
    failed calls
      ✓ should throw error when function fails (11 ms)
      ✓ should track failed calls in statistics (6 ms)
      ✓ should increment failure count
    circuit states
      ✓ should open circuit after threshold failures (28 ms)
      ✓ should reject calls when circuit is OPEN (2 ms)
      ✓ should transition to HALF_OPEN after reset timeout (2105 ms)
      ✓ should close circuit after success threshold in HALF_OPEN (2103 ms)
      ✓ should reopen circuit if failure occurs in HALF_OPEN (2104 ms)
    timeout handling
      ✓ should timeout slow functions (1001 ms)
      ✓ should count timeouts as failures (1000 ms)
      ✓ should not timeout fast functions (101 ms)
    statistics tracking
      ✓ should track last failure time
      ✓ should track last success time
      ✓ should track total calls
    reset functionality
      ✓ should reset circuit to CLOSED state (1 ms)
      ✓ should reset failure count (1 ms)
      ✓ should allow calls after reset (1 ms)
    concurrent calls
      ✓ should handle multiple concurrent successful calls
      ✓ should handle mixed concurrent calls
    real-world scenarios
      ✓ should protect against cascading failures (1 ms)
      ✓ should allow recovery after service restoration (2103 ms)
      ✓ should track degraded service patterns

FAIL tests/integration/queue.service.test.ts (35.112 s)
  ● QueueService Integration Tests › initialization › should emit connected event on successful connection

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      21 |     });
      22 |
    > 23 |     it('should emit connected event on successful connection', (done) => {
         |     ^
      24 |       QueueService.once('connected', () => {
      25 |         done();
      26 |       });

      at tests/integration/queue.service.test.ts:23:5
      at tests/integration/queue.service.test.ts:18:3
      at Object.<anonymous> (tests/integration/queue.service.test.ts:9:1)

  ● QueueService Integration Tests › consume operations › should consume messages from queue

    Operation failed: BasicConsume; 404 (NOT-FOUND) with message "NOT_FOUND - no queue 'test-consume-queue' in vhost '/'"

      at reply (node_modules/amqplib/lib/channel.js:141:31)
      at Channel.accept (node_modules/amqplib/lib/channel.js:319:9)
      at Connection.mainAccept (node_modules/amqplib/lib/connection.js:579:33)
      at Socket.go (node_modules/amqplib/lib/connection.js:431:16)

  ● QueueService Integration Tests › consume operations › should handle message processing errors

    IllegalOperationError: Channel closed

      109 |     }
      110 |
    > 111 |     await this.consumeChannel.prefetch(1);
          |                               ^
      112 |
      113 |     await this.consumeChannel.consume(queue, async (msg: any) => {
      114 |       if (!msg) return;

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel._rpc (node_modules/amqplib/lib/channel.js:149:10)
      at node_modules/amqplib/lib/channel_model.js:63:19
      at Channel.rpc (node_modules/amqplib/lib/channel_model.js:64:7)
      at Channel.qos (node_modules/amqplib/lib/channel_model.js:250:17)
      at QueueServiceClass.consume (src/services/queueService.ts:111:31)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:113:26)

  ● QueueService Integration Tests › consume operations › should acknowledge successful message processing

    IllegalOperationError: Channel closed

      109 |     }
      110 |
    > 111 |     await this.consumeChannel.prefetch(1);
          |                               ^
      112 |
      113 |     await this.consumeChannel.consume(queue, async (msg: any) => {
      114 |       if (!msg) return;

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel._rpc (node_modules/amqplib/lib/channel.js:149:10)
      at node_modules/amqplib/lib/channel_model.js:63:19
      at Channel.rpc (node_modules/amqplib/lib/channel_model.js:64:7)
      at Channel.qos (node_modules/amqplib/lib/channel_model.js:250:17)
      at QueueServiceClass.consume (src/services/queueService.ts:111:31)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:130:26)

  ● QueueService Integration Tests › message serialization › should handle JSON serialization

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:153:26)

  ● QueueService Integration Tests › message serialization › should handle special characters in messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:170:26)

  ● QueueService Integration Tests › message serialization › should handle unicode in messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:187:26)

  ● QueueService Integration Tests › queue durability › should create durable queues

    expect(received).resolves.not.toThrow()

    Received promise rejected instead of resolved
    Rejected to value: [IllegalOperationError: Channel closed]

      201 |     it('should create durable queues', async () => {
      202 |       // Publishing to configured queues should work (they're durable)
    > 203 |       await expect(
          |             ^
      204 |         QueueService.publish(config.rabbitmq.queues.ticketEvents, {
      205 |           type: 'DURABLE_TEST'
      206 |         })

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:203:13)

  ● QueueService Integration Tests › queue durability › should persist messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:216:26)

  ● QueueService Integration Tests › concurrent operations › should handle multiple concurrent publishes

    expect(received).resolves.not.toThrow()

    Received promise rejected instead of resolved
    Rejected to value: [IllegalOperationError: Channel closed]

      236 |       }
      237 |
    > 238 |       await expect(Promise.all(promises)).resolves.not.toThrow();
          |             ^
      239 |     });
      240 |
      241 |     it('should process multiple messages sequentially', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:238:13)

  ● QueueService Integration Tests › concurrent operations › should process multiple messages sequentially

    IllegalOperationError: Channel closed

      109 |     }
      110 |
    > 111 |     await this.consumeChannel.prefetch(1);
          |                               ^
      112 |
      113 |     await this.consumeChannel.consume(queue, async (msg: any) => {
      114 |       if (!msg) return;

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel._rpc (node_modules/amqplib/lib/channel.js:149:10)
      at node_modules/amqplib/lib/channel_model.js:63:19
      at Channel.rpc (node_modules/amqplib/lib/channel_model.js:64:7)
      at Channel.qos (node_modules/amqplib/lib/channel_model.js:250:17)
      at QueueServiceClass.consume (src/services/queueService.ts:111:31)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:245:26)

  ● QueueService Integration Tests › connection status › should handle graceful shutdown

    expect(received).resolves.not.toThrow()

    Received promise rejected instead of resolved
    Rejected to value: [IllegalOperationError: Channel closed]

      266 |     it('should handle graceful shutdown', async () => {
      267 |       // Service should close without errors
    > 268 |       await expect(QueueService.close()).resolves.not.toThrow();
          |             ^
      269 |
      270 |       expect(QueueService.isConnected()).toBe(false);
      271 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:268:13)

  ● QueueService Integration Tests › error handling › should handle publishing when not initialized

    IllegalOperationError: Channel closed

      138 |
      139 |     if (this.publishChannel) {
    > 140 |       await this.publishChannel.close();
          |                                 ^
      141 |     }
      142 |
      143 |     if (this.consumeChannel) {

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.closeBecause (node_modules/amqplib/lib/channel.js:198:10)
      at node_modules/amqplib/lib/channel_model.js:78:19
      at Channel.close (node_modules/amqplib/lib/channel_model.js:80:7)
      at QueueServiceClass.close (src/services/queueService.ts:140:33)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:279:26)

  ● QueueService Integration Tests › error handling › should handle invalid queue names gracefully

    expect(received).resolves.not.toThrow()

    Received promise rejected instead of resolved
    Rejected to value: [IllegalOperationError: Channel closed]

      290 |     it('should handle invalid queue names gracefully', async () => {
      291 |       // RabbitMQ accepts most queue names
    > 292 |       await expect(
          |             ^
      293 |         QueueService.publish('test.queue.name', { type: 'TEST' })
      294 |       ).resolves.not.toThrow();
      295 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:292:13)

  ● QueueService Integration Tests › message types › should handle ticket events

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:306:26)

  ● QueueService Integration Tests › message types › should handle NFT minting requests

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:319:26)

  ● QueueService Integration Tests › message types › should handle notification messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:332:26)

  ● QueueService Integration Tests › message validation › should publish empty objects

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:341:26)

  ● QueueService Integration Tests › message validation › should handle large messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:350:26)

  ● QueueService Integration Tests › message validation › should handle messages with dates

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:359:26)

  ● QueueService Integration Tests › consumer patterns › should support multiple consumers on same queue

    IllegalOperationError: Channel closed

      109 |     }
      110 |
    > 111 |     await this.consumeChannel.prefetch(1);
          |                               ^
      112 |
      113 |     await this.consumeChannel.consume(queue, async (msg: any) => {
      114 |       if (!msg) return;

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel._rpc (node_modules/amqplib/lib/channel.js:149:10)
      at node_modules/amqplib/lib/channel_model.js:63:19
      at Channel.rpc (node_modules/amqplib/lib/channel_model.js:64:7)
      at Channel.qos (node_modules/amqplib/lib/channel_model.js:250:17)
      at QueueServiceClass.consume (src/services/queueService.ts:111:31)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:378:26)


  ● Test suite failed to run

    IllegalOperationError: Channel closed

      138 |
      139 |     if (this.publishChannel) {
    > 140 |       await this.publishChannel.close();
          |                                 ^
      141 |     }
      142 |
      143 |     if (this.consumeChannel) {

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.closeBecause (node_modules/amqplib/lib/channel.js:198:10)
      at node_modules/amqplib/lib/channel_model.js:78:19
      at Channel.close (node_modules/amqplib/lib/channel_model.js:80:7)
      at QueueServiceClass.close (src/services/queueService.ts:140:33)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:15:24)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL tests/integration/refund-handler.test.ts (5.428 s)
  ● RefundHandler Integration Tests › initiateRefund › should update order status to REFUND_INITIATED

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should write refund event to outbox

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should include order ID in payload

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should include payment intent ID in payload

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should include refund amount in cents

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should include refund reason in payload

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should return success response

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should throw error if order not found

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should update timestamp

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle empty reason

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle long reason text

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle special characters in reason

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle refund for different order amounts

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle refund for order without payment intent

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle concurrent refund requests

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle refund already in progress

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle NULL order ID

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle undefined order ID

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › initiateRefund › should handle malformed order ID

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle customer-initiated refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle event cancellation refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle duplicate payment refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle fraud-related refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › refund reasons › should handle system error refund

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › error handling › should rollback on outbox write failure

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › error handling › should handle database connection error gracefully

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › error handling › should log error on failure

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › error handling › should throw with descriptive error message

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › integration with payment service › should include all required fields for payment service

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › integration with payment service › should format amount correctly for payment service

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › integration with payment service › should preserve payment intent ID format

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › idempotency › should prevent duplicate refund initiations

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

  ● RefundHandler Integration Tests › idempotency › should maintain data integrity on retry

    error: null value in column "tenant_id" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/refund-handler.test.ts:23:20)

FAIL tests/integration/payment-event-handler.test.ts (5.488 s)
  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should update order status to PAID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should set payment intent ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should update timestamp

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should queue NFT minting job

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should include venue ID in mint job

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should include quantity in mint job

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should write event to outbox

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should include payload in outbox

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should throw error if order not found

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should rollback on queue publish failure

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should rollback on outbox write failure

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should handle transaction atomically

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should handle concurrent payment success

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should include timestamp in mint job

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should handle order with different quantities

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentSucceeded › should handle payment with special characters in ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should update order status to PAYMENT_FAILED

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should update timestamp on failure

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle various failure reasons

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle empty reason

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle very long reason

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should not throw on nonexistent order

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle payment failure after success

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle concurrent failures

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should handle special characters in reason

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › handlePaymentFailed › should preserve other order fields on failure

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › edge cases › should handle NULL payment ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › edge cases › should handle undefined order ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › edge cases › should handle malformed order ID

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

  ● PaymentEventHandler Integration Tests › edge cases › should handle order without event association

    error: invalid input syntax for type json

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/payment-event-handler.test.ts:29:5)

FAIL tests/integration/orders.controller.test.ts
  ● OrdersController Integration Tests › getOrderById › should return order for authenticated user

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should return order for authenticated user

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should return 400 if orderId is missing

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should return 400 if orderId is missing

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should return 401 if user not authenticated

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should return 401 if user not authenticated

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should return 404 if order not found

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should return 404 if order not found

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should prevent users from accessing other users orders

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should prevent users from accessing other users orders

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getOrderById › should format prices correctly

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getOrderById › should format prices correctly

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should return all orders for authenticated user

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should return all orders for authenticated user

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should return 401 if user not authenticated

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should return 401 if user not authenticated

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should filter by status

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should filter by status

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should support pagination

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should support pagination

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserOrders › should return empty array for user with no orders

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserOrders › should return empty array for user with no orders

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should return all tickets for authenticated user

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should return all tickets for authenticated user

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should return 401 if user not authenticated

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should return 401 if user not authenticated

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should filter by event ID

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should filter by event ID

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should filter by status

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should filter by status

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should include formatted prices

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should include formatted prices

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › getUserTickets › should return empty array for user with no tickets

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › getUserTickets › should return empty array for user with no tickets

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › security and tenant isolation › should prevent cross-tenant order access

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › security and tenant isolation › should prevent cross-tenant order access

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › security and tenant isolation › should prevent cross-tenant ticket access

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › security and tenant isolation › should prevent cross-tenant ticket access

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › security and tenant isolation › should use tenant context in database queries

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › security and tenant isolation › should use tenant context in database queries

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › error handling › should handle database errors gracefully

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › error handling › should handle database errors gracefully

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › error handling › should include request ID in error responses

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › error handling › should include request ID in error responses

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › data consistency › should return consistent order and item data

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › data consistency › should return consistent order and item data

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

  ● OrdersController Integration Tests › data consistency › should maintain correct ticket counts

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:37:5)

  ● OrdersController Integration Tests › data consistency › should maintain correct ticket counts

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/orders.controller.test.ts:86:5)

FAIL tests/integration/reservation-cleanup.worker.test.ts
  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should start worker successfully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should start worker successfully

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should stop worker successfully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should stop worker successfully

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should prevent multiple concurrent runs

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should prevent multiple concurrent runs

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should track metrics

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › worker lifecycle › should track metrics

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should release expired reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should release expired reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should not affect active reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should not affect active reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should publish expired events to outbox

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should publish expired events to outbox

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should clear Redis entries for expired reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should clear Redis entries for expired reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should update metrics after releasing reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › releaseExpiredReservations › should update metrics after releasing reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › fixOrphanReservations › should detect orphan reservations with no order

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › fixOrphanReservations › should detect orphan reservations with no order

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › fixOrphanReservations › should record orphan fixes in history

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › fixOrphanReservations › should record orphan fixes in history

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should remove stale Redis entries

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should remove stale Redis entries

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should keep Redis entries for active reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should keep Redis entries for active reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should remove Redis entries for expired reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › cleanupRedisReservations › should remove Redis entries for expired reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should detect negative inventory

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should detect negative inventory

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should publish alerts for negative inventory

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should publish alerts for negative inventory

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should handle discrepancies between reserved and available

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › reconcileInventory › should handle discrepancies between reserved and available

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should handle database errors gracefully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should handle database errors gracefully

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should continue running after errors

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should continue running after errors

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should not run cleanup concurrently

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › error handling › should not run cleanup concurrently

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › notifications › should send alerts for many orphans

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › notifications › should send alerts for many orphans

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › notifications › should include metrics in notifications

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › notifications › should include metrics in notifications

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track total released count

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track total released count

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track orphans found

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track orphans found

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track orphans fixed

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track orphans fixed

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track errors

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track errors

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track last run time

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should track last run time

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should increment metrics correctly

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › metrics tracking › should increment metrics correctly

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should handle mixed active and expired reservations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should handle mixed active and expired reservations

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should cleanup across multiple runs

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should cleanup across multiple runs

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should handle empty database

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:31:5)

  ● ReservationCleanupWorker Integration Tests › integration scenarios › should handle empty database

    error: relation "reservation_history" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-cleanup.worker.test.ts:42:5)

FAIL tests/integration/reservation-expiry.worker.test.ts (6.868 s)
  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should expire reservations past expiry time

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:87:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should not expire future reservations

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:111:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should write expiry events to outbox

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:134:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should include correct payload in outbox events

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:160:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should process multiple expired reservations

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:191:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should handle reservations without order_id

    error: null value in column "ticket_type_id" of relation "reservations" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:219:7)

  ● ReservationExpiryWorker Integration Tests › processExpiredReservations › should run immediately on start

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:242:7)

  ● ReservationExpiryWorker Integration Tests › stored procedure integration › should call release_expired_reservations procedure

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:295:7)

  ● ReservationExpiryWorker Integration Tests › stored procedure integration › should get count of released reservations

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:320:7)

  ● ReservationExpiryWorker Integration Tests › stored procedure integration › should only process recently expired reservations for outbox

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:348:7)

  ● ReservationExpiryWorker Integration Tests › error handling › should handle invalid reservation data

    error: null value in column "ticket_type_id" of relation "reservations" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:422:7)

  ● ReservationExpiryWorker Integration Tests › timing and intervals › should process on each interval

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:455:7)

  ● ReservationExpiryWorker Integration Tests › integration scenarios › should handle mixed statuses

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:494:7)

  ● ReservationExpiryWorker Integration Tests › integration scenarios › should process reservations from different users

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:527:7)

  ● ReservationExpiryWorker Integration Tests › integration scenarios › should handle high volume of expirations

    error: column "order_id" of relation "reservations" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/reservation-expiry.worker.test.ts:564:9)

FAIL tests/integration/qr.controller.test.ts
  ● QRController Integration Tests › generateQR › should generate QR code for ticket owner

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should generate QR code for ticket owner

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › generateQR › should reject non-owner access

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should reject non-owner access

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › generateQR › should allow admin access to any ticket

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should allow admin access to any ticket

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › generateQR › should enforce tenant isolation

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should enforce tenant isolation

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › generateQR › should return QR code with 30 second expiry

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › generateQR › should return QR code with 30 second expiry

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › validateQR › should validate valid QR code

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › validateQR › should validate valid QR code

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › validateQR › should reject invalid QR code

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › validateQR › should reject invalid QR code

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › validateQR › should include validation metadata

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › validateQR › should include validation metadata

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should refresh QR code for ticket owner

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should refresh QR code for ticket owner

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should reject non-owner refresh

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should reject non-owner refresh

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should allow admin to refresh any ticket

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should allow admin to refresh any ticket

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should generate new QR code on refresh

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should generate new QR code on refresh

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › refreshQR › should enforce tenant isolation on refresh

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › refreshQR › should enforce tenant isolation on refresh

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › security › should prevent access to tickets from other tenants

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › security › should prevent access to tickets from other tenants

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › security › should verify ticket ownership before operations

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › security › should verify ticket ownership before operations

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › security › should handle missing ticket gracefully

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › security › should handle missing ticket gracefully

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › edge cases › should handle rapid refresh requests

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › edge cases › should handle rapid refresh requests

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

  ● QRController Integration Tests › edge cases › should handle validation with missing fields

    error: null value in column "ticket_type_id" of relation "tickets" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:29:5)

  ● QRController Integration Tests › edge cases › should handle validation with missing fields

    error: relation "qr_codes" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.controller.test.ts:37:5)

FAIL tests/integration/mintWorker.test.ts
  ● MintWorker Integration Tests › processMintJob › should successfully mint a single ticket

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should create ticket in database

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should mint multiple tickets

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should store NFT data in metadata

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should set is_nft flag to true

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should set is_transferable to true

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique ticket numbers

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should generate QR codes for each ticket

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should update order status to COMPLETED

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should publish order.completed event to outbox

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should use tenant from order if not provided

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › processMintJob › should use ticketTypeId from order if not provided

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should throw error for non-existent order

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should rollback transaction on error

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should set order status to MINT_FAILED on error

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should publish order.mint_failed event on error

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should handle missing ticket type gracefully

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › error handling › should handle missing tenant gracefully

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › NFT minting › should generate unique NFT addresses

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › NFT minting › should generate transaction signatures

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › NFT minting › should include minted_at timestamp in metadata

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › transaction handling › should commit all changes on success

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › transaction handling › should maintain atomicity

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › edge cases › should handle quantity of 0

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › edge cases › should handle large quantities

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › edge cases › should set transfer_count to 0

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

  ● MintWorker Integration Tests › edge cases › should handle concurrent mint jobs for different orders

    error: null value in column "order_number" of relation "orders" violates not-null constraint

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mintWorker.test.ts:29:5)

FAIL tests/integration/purchase.controller.test.ts
  ● PurchaseController Integration Tests › createOrder - idempotency › should create order with valid idempotency key

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should create order with valid idempotency key

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should return cached response for duplicate idempotency key

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should return cached response for duplicate idempotency key

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should reject request without idempotency key

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - idempotency › should reject request without idempotency key

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without eventId

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without eventId

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without items

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without items

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request with empty items array

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request with empty items array

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without tenantId

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - validation › should reject request without tenantId

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should reduce available quantity when order is created

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should reduce available quantity when order is created

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should reject order when insufficient inventory

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should reject order when insufficient inventory

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should handle concurrent order attempts atomically

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - inventory management › should handle concurrent order attempts atomically

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should calculate correct total with fees

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should calculate correct total with fees

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should include formatted price in response

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should include formatted price in response

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should handle multiple ticket types in one order

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - pricing and fees › should handle multiple ticket types in one order

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - discount codes › should apply valid discount code

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - discount codes › should apply valid discount code

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - discount codes › should handle invalid discount codes gracefully

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - discount codes › should handle invalid discount codes gracefully

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - tenant isolation › should prevent cross-tenant ticket type purchases

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - tenant isolation › should prevent cross-tenant ticket type purchases

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - tenant isolation › should validate all ticket types belong to same tenant

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - tenant isolation › should validate all ticket types belong to same tenant

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should create order record in database

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should create order record in database

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should create order items in database

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should create order items in database

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should set expiration time for order reservation

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › createOrder - data persistence › should set expiration time for order reservation

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › error handling and rollback › should rollback inventory on order creation failure

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › error handling and rollback › should rollback inventory on order creation failure

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

  ● PurchaseController Integration Tests › error handling and rollback › should handle malformed ticket type IDs

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:32:5)

  ● PurchaseController Integration Tests › error handling and rollback › should handle malformed ticket type IDs

    error: relation "idempotency_keys" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase.controller.test.ts:54:5)

FAIL tests/integration/mint.worker.test.ts
  ● MintWorker Integration Tests › processMintJob › should successfully mint single ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should successfully mint single ticket

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should create ticket with NFT metadata

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should create ticket with NFT metadata

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should mint multiple tickets

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should mint multiple tickets

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique ticket numbers for each ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique ticket numbers for each ticket

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique QR codes for each ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should generate unique QR codes for each ticket

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should update order status to COMPLETED

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should update order status to COMPLETED

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should create outbox event for completed order

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should create outbox event for completed order

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › processMintJob › should use order data when job parameters missing

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › processMintJob › should use order data when job parameters missing

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should rollback on failure

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should rollback on failure

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should handle missing ticket type

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should handle missing ticket type

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should handle missing tenant

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should handle missing tenant

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should update order to MINT_FAILED on error

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should update order to MINT_FAILED on error

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › error handling › should create mint_failed outbox event on error

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › error handling › should create mint_failed outbox event on error

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › transaction integrity › should be atomic - all tickets or none

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › transaction integrity › should be atomic - all tickets or none

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › transaction integrity › should not create tickets if order update fails

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › transaction integrity › should not create tickets if order update fails

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › NFT minting › should generate unique NFT addresses

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › NFT minting › should generate unique NFT addresses

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › NFT minting › should generate transaction signatures

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › NFT minting › should generate transaction signatures

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › NFT minting › should include NFT metadata in ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › NFT minting › should include NFT metadata in ticket

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › data consistency › should maintain referential integrity

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › data consistency › should maintain referential integrity

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › data consistency › should set correct ticket properties

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › data consistency › should set correct ticket properties

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › data consistency › should set purchased_at timestamp

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › data consistency › should set purchased_at timestamp

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › edge cases › should handle zero quantity jobs

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › edge cases › should handle zero quantity jobs

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

  ● MintWorker Integration Tests › edge cases › should handle large batch minting

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:31:5)

  ● MintWorker Integration Tests › edge cases › should handle large batch minting

    error: column "tenant_id" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/mint.worker.test.ts:74:5)

FAIL tests/integration/transfer.controller.test.ts
  ● TransferController Integration Tests › transferTicket › should successfully transfer ticket from owner to recipient

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should successfully transfer ticket from owner to recipient

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should create transfer record in database

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should create transfer record in database

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should record transfer with optional reason

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should record transfer with optional reason

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should prevent unauthorized transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should prevent unauthorized transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should prevent transfer of non-existent ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should prevent transfer of non-existent ticket

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should prevent transfer to same user

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should prevent transfer to same user

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should log audit trail for successful transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should log audit trail for successful transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › transferTicket › should log audit trail for failed transfer attempt

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › transferTicket › should log audit trail for failed transfer attempt

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › getTransferHistory › should return transfer history for a ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › getTransferHistory › should return transfer history for a ticket

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › getTransferHistory › should return empty array for ticket with no transfers

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › getTransferHistory › should return empty array for ticket with no transfers

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › getTransferHistory › should return transfers in chronological order

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › getTransferHistory › should return transfers in chronological order

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › getTransferHistory › should include transfer metadata

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › getTransferHistory › should include transfer metadata

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should validate transfer from owner

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should validate transfer from owner

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation from non-owner

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation from non-owner

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for non-existent ticket

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for non-existent ticket

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for self-transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for self-transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for used tickets

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should reject validation for used tickets

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › validateTransfer › should include validation reason in response

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › validateTransfer › should include validation reason in response

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › security and tenant isolation › should prevent cross-tenant transfer access

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › security and tenant isolation › should prevent cross-tenant transfer access

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › security and tenant isolation › should validate ticket ownership before transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › security and tenant isolation › should validate ticket ownership before transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › edge cases › should handle rapid transfer attempts

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › edge cases › should handle rapid transfer attempts

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › edge cases › should handle transfer with missing toUserId

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › edge cases › should handle transfer with missing toUserId

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › edge cases › should handle transfer with missing ticketId

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › edge cases › should handle transfer with missing ticketId

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › data consistency › should maintain referential integrity during transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › data consistency › should maintain referential integrity during transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

  ● TransferController Integration Tests › data consistency › should preserve ticket metadata during transfer

    error: column "tenant_id" of relation "venues" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:33:5)

  ● TransferController Integration Tests › data consistency › should preserve ticket metadata during transfer

    error: relation "transfers" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.controller.test.ts:62:5)

FAIL tests/integration/purchase-saga.test.ts
  ● PurchaseSaga Integration Tests › successful purchase flow › should complete all 3 steps successfully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should reserve inventory atomically

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should create order via order service

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should create tickets in database

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should handle multiple item types

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should pass idempotency key to order service

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should include tenant in order metadata

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › successful purchase flow › should pass discount codes to order service

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › inventory management › should fail if insufficient inventory

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › inventory management › should not modify inventory on insufficient stock

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › inventory management › should handle concurrent purchases correctly

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › inventory management › should update reserved_quantity correctly

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 2 failure (order service) › should release inventory if order creation fails

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 2 failure (order service) › should not create tickets if order fails

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 2 failure (order service) › should handle OrderServiceError specifically

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 3 failure (ticket creation) › should cancel order if ticket creation fails

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › compensation - step 3 failure (ticket creation) › should release inventory if ticket creation fails

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › transaction atomicity › should rollback all changes on failure

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › transaction atomicity › should maintain consistency across all operations

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should handle zero quantity gracefully

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should handle non-existent ticket type

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should handle empty items array

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should enforce tenant isolation

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

  ● PurchaseSaga Integration Tests › edge cases › should handle large quantities

    error: column "total_quantity" of relation "ticket_types" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/purchase-saga.test.ts:42:5)

FAIL tests/integration/transfer.service.test.ts
  ● TransferService Integration Tests › transferTicket › should successfully transfer ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should update ticket ownership

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should create transfer record

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should reject transfer from non-owner

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should reject transfer for incorrect status

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should reject transfer when event disallows transfers

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should reject transfer past deadline

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should enforce max transfer limit

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transferTicket › should transfer without reason parameter

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should validate successful transfer

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject self-transfer

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer to inactive user

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer to unverified email

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer when recipient cannot receive

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject non-transferable ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject locked ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer for non-existent ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › validateTransferRequest › should reject transfer to non-existent user

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › getTransferHistory › should return empty history for untransferred ticket

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › getTransferHistory › should return transfer history after transfer

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › getTransferHistory › should return multiple transfers in order

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › transfer cooldown › should enforce cooldown period between transfers

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › rate limiting › should enforce daily transfer limit

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › blackout periods › should reject transfers during blackout

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › identity verification › should require identity verification when enabled

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › identity verification › should allow transfer when both users verified

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › edge cases › should handle missing venue transfer deadline

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

  ● TransferService Integration Tests › edge cases › should handle ticket without transfer_history

    error: column "can_receive_transfers" of relation "users" does not exist

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/transfer.service.test.ts:25:22)

FAIL tests/integration/qr.service.test.ts
  ● QRService Integration Tests › generateRotatingQR › should generate QR code for valid ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › generateRotatingQR › should generate different QR codes over time

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › generateRotatingQR › should throw error for non-existent ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › generateRotatingQR › should store validation data in Redis

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › generateRotatingQR › should generate QR image with correct dimensions

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should successfully validate fresh QR code

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should reject already used ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should reject QR for wrong event

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should reject invalid QR format

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should reject expired QR code

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should create validation record in database

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should update ticket status to USED

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validateQR › should clear ticket cache after validation

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › encryption and decryption › should encrypt and decrypt QR data

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › encryption and decryption › should handle corrupted encrypted data

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › encryption and decryption › should generate unique nonces for each QR

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › concurrent validation prevention › should prevent double validation with row locking

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › edge cases › should handle ticket with no seat information

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › edge cases › should handle validation without optional fields

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › edge cases › should reject validation for reserved ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › edge cases › should reject validation for cancelled ticket

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › QR image generation › should generate base64 PNG image

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › QR image generation › should generate scannable QR image

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › Redis failure handling › should generate QR even if Redis is unavailable

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › Redis failure handling › should validate QR even if Redis cache clear fails

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

  ● QRService Integration Tests › validation data integrity › should store complete validation information

    error: invalid input syntax for type uuid: "test-event-123"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/qr.service.test.ts:24:20)

FAIL tests/integration/discount.service.test.ts
  ● DiscountService Integration Tests › validateDiscountCode › should validate event-specific discount

    error: insert or update on table "discounts" violates foreign key constraint "discounts_event_id_fkey"

      83 |     }
      84 |
    > 85 |     const result = await this.pool.query(text, params);
         |                    ^
      86 |     return { rows: result.rows, rowCount: result.rowCount };
      87 |   }
      88 |

      at node_modules/pg-pool/index.js:45:11
      at DatabaseServiceClass.query (src/services/databaseService.ts:85:20)
      at Object.<anonymous> (tests/integration/discount.service.test.ts:358:29)

FAIL tests/integration/ticket.controller.test.ts
  ● Test suite failed to run

    [96mtests/integration/ticket.controller.test.ts[0m:[93m53[0m:[93m17[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m53[0m     await cache.clear();
    [7m  [0m [91m                ~~~~~[0m

FAIL tests/integration/tenant.middleware.test.ts
  ● Test suite failed to run

    [96mtests/integration/tenant.middleware.test.ts[0m:[93m314[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ headers: { 'x-tenant-id': string; }; tenantId: undefined; }' is not assignable to parameter of type 'FastifyRequest<RouteGenericInterface, RawServerDefault, IncomingMessage, FastifySchema, FastifyTypeProviderDefault, unknown, FastifyBaseLogger, ResolveFastifyRequestType<...>>'.
      Type '{ headers: { 'x-tenant-id': string; }; tenantId: undefined; }' is missing the following properties from type 'FastifyRequest<RouteGenericInterface, RawServerDefault, IncomingMessage, FastifySchema, FastifyTypeProviderDefault, unknown, FastifyBaseLogger, ResolveFastifyRequestType<...>>': id, params, raw, query, and 21 more.

    [7m314[0m         await tenantMiddleware(req, mockReply);
    [7m   [0m [91m                               ~~~[0m
    [96mtests/integration/tenant.middleware.test.ts[0m:[93m324[0m:[93m32[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ headers: { 'x-tenant-id': string; }; tenantId: undefined; }' is not assignable to parameter of type 'FastifyRequest<RouteGenericInterface, RawServerDefault, IncomingMessage, FastifySchema, FastifyTypeProviderDefault, unknown, FastifyBaseLogger, ResolveFastifyRequestType<...>>'.
      Type '{ headers: { 'x-tenant-id': string; }; tenantId: undefined; }' is missing the following properties from type 'FastifyRequest<RouteGenericInterface, RawServerDefault, IncomingMessage, FastifySchema, FastifyTypeProviderDefault, unknown, FastifyBaseLogger, ResolveFastifyRequestType<...>>': id, params, raw, query, and 21 more.

    [7m324[0m         await tenantMiddleware(req, mockReply);
    [7m   [0m [91m                               ~~~[0m

FAIL tests/integration/solana.service.test.ts
  ● Test suite failed to run

    [96mtests/integration/solana.service.test.ts[0m:[93m54[0m:[93m50[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; description: string; }; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; description: string; }; }' but required in type 'NFTMintRequest'.

    [7m54[0m       const result = await SolanaService.mintNFT(request);
    [7m  [0m [91m                                                 ~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m78[0m:[93m51[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' but required in type 'NFTMintRequest'.

    [7m78[0m       const result1 = await SolanaService.mintNFT(request1);
    [7m  [0m [91m                                                  ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m80[0m:[93m51[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' but required in type 'NFTMintRequest'.

    [7m80[0m       const result2 = await SolanaService.mintNFT(request2);
    [7m  [0m [91m                                                  ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m103[0m:[93m50[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; description: string; image: string; attributes: { trait_type: string; value: string; }[]; }; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; description: string; image: string; attributes: { trait_type: string; value: string; }[]; }; }' but required in type 'NFTMintRequest'.

    [7m103[0m       const result = await SolanaService.mintNFT(request);
    [7m   [0m [91m                                                 ~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m118[0m:[93m51[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' but required in type 'NFTMintRequest'.

    [7m118[0m         requests.map(req => SolanaService.mintNFT(req))
    [7m   [0m [91m                                                  ~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m207[0m:[93m50[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: {}; }' but required in type 'NFTMintRequest'.

    [7m207[0m       const result = await SolanaService.mintNFT(request);
    [7m   [0m [91m                                                 ~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.
    [96mtests/integration/solana.service.test.ts[0m:[93m226[0m:[93m9[0m - [91merror[0m[90m TS2740: [0mType '{}' is missing the following properties from type '{ eventId: string; eventName: string; venueName: string; eventDate: string; ticketType: string; seatInfo?: string | undefined; imageUrl: string; }': eventId, eventName, venueName, eventDate, and 2 more.

    [7m226[0m         metadata: {}
    [7m   [0m [91m        ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m178[0m:[93m3[0m
        [7m178[0m   metadata: {
        [7m   [0m [96m  ~~~~~~~~[0m
        The expected type comes from property 'metadata' which is declared here on type 'NFTMintRequest'
    [96mtests/integration/solana.service.test.ts[0m:[93m249[0m:[93m9[0m - [91merror[0m[90m TS2740: [0mType '{}' is missing the following properties from type '{ eventId: string; eventName: string; venueName: string; eventDate: string; ticketType: string; seatInfo?: string | undefined; imageUrl: string; }': eventId, eventName, venueName, eventDate, and 2 more.

    [7m249[0m         metadata: {}
    [7m   [0m [91m        ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m178[0m:[93m3[0m
        [7m178[0m   metadata: {
        [7m   [0m [96m  ~~~~~~~~[0m
        The expected type comes from property 'metadata' which is declared here on type 'NFTMintRequest'
    [96mtests/integration/solana.service.test.ts[0m:[93m278[0m:[93m11[0m - [91merror[0m[90m TS2740: [0mType '{}' is missing the following properties from type '{ eventId: string; eventName: string; venueName: string; eventDate: string; ticketType: string; seatInfo?: string | undefined; imageUrl: string; }': eventId, eventName, venueName, eventDate, and 2 more.

    [7m278[0m           metadata: {}
    [7m   [0m [91m          ~~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m178[0m:[93m3[0m
        [7m178[0m   metadata: {
        [7m   [0m [96m  ~~~~~~~~[0m
        The expected type comes from property 'metadata' which is declared here on type 'NFTMintRequest'
    [96mtests/integration/solana.service.test.ts[0m:[93m313[0m:[93m50[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; symbol: string; description: string; seller_fee_basis_points: number; image: string; external_url: string; attributes: { ...; }[]; properties: { ...; }; }; }' is not assignable to parameter of type 'NFTMintRequest'.
      Property 'owner' is missing in type '{ ticketId: string; userId: string; eventId: string; metadata: { name: string; symbol: string; description: string; seller_fee_basis_points: number; image: string; external_url: string; attributes: { ...; }[]; properties: { ...; }; }; }' but required in type 'NFTMintRequest'.

    [7m313[0m       const result = await SolanaService.mintNFT(request);
    [7m   [0m [91m                                                 ~~~~~~~[0m

      [96msrc/types/index.ts[0m:[93m177[0m:[93m3[0m
        [7m177[0m   owner: string;
        [7m   [0m [96m  ~~~~~[0m
        'owner' is declared here.

FAIL tests/integration/inter-service-client.test.ts
  ● Test suite failed to run

    [96mtests/integration/inter-service-client.test.ts[0m:[93m3[0m:[93m25[0m - [91merror[0m[90m TS2307: [0mCannot find module 'axios-mock-adapter' or its corresponding type declarations.

    [7m3[0m import MockAdapter from 'axios-mock-adapter';
    [7m [0m [91m                        ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/inter-service-client.test.ts[0m:[93m139[0m:[93m37[0m - [91merror[0m[90m TS7006: [0mParameter 'config' implicitly has an 'any' type.

    [7m139[0m       mock.onGet(/\/headers/).reply(config => {
    [7m   [0m [91m                                    ~~~~~~[0m
    [96mtests/integration/inter-service-client.test.ts[0m:[93m332[0m:[93m35[0m - [91merror[0m[90m TS7006: [0mParameter 'config' implicitly has an 'any' type.

    [7m332[0m       mock.onGet(/\/trace/).reply(config => {
    [7m   [0m [91m                                  ~~~~~~[0m
    [96mtests/integration/inter-service-client.test.ts[0m:[93m465[0m:[93m35[0m - [91merror[0m[90m TS7006: [0mParameter 'config' implicitly has an 'any' type.

    [7m465[0m       mock.onPost(/\/json/).reply(config => {
    [7m   [0m [91m                                  ~~~~~~[0m

FAIL tests/integration/rate-limit.middleware.test.ts
  ● Test suite failed to run

    [96mtests/integration/rate-limit.middleware.test.ts[0m:[93m485[0m:[93m15[0m - [91merror[0m[90m TS7022: [0m'rep' implicitly has type 'any' because it does not have a type annotation and is referenced directly or indirectly in its own initializer.

    [7m485[0m         const rep = {
    [7m   [0m [91m              ~~~[0m
    [96mtests/integration/rate-limit.middleware.test.ts[0m:[93m487[0m:[93m45[0m - [91merror[0m[90m TS2448: [0mBlock-scoped variable 'rep' used before its declaration.

    [7m487[0m           header: jest.fn().mockReturnValue(rep),
    [7m   [0m [91m                                            ~~~[0m

      [96mtests/integration/rate-limit.middleware.test.ts[0m:[93m485[0m:[93m15[0m
        [7m485[0m         const rep = {
        [7m   [0m [96m              ~~~[0m
        'rep' is declared here.

FAIL tests/integration/error-handler.middleware.test.ts
  ● Test suite failed to run

    [96mtests/integration/error-handler.middleware.test.ts[0m:[93m2[0m:[93m50[0m - [91merror[0m[90m TS2305: [0mModule '"../../src/utils/errors"' has no exported member 'BadRequestError'.

    [7m2[0m import { AppError, NotFoundError, ConflictError, BadRequestError, UnauthorizedError } from '../../src/utils/errors';
    [7m [0m [91m                                                 ~~~~~~~~~~~~~~~[0m

FAIL tests/integration/cache-integration.test.ts
  ● Test suite failed to run

    [96mtests/integration/cache-integration.test.ts[0m:[93m25[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m25[0m       expect(cache.del).toBeDefined();
    [7m  [0m [91m                   ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m26[0m:[93m27[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m26[0m       expect(typeof cache.del).toBe('function');
    [7m  [0m [91m                          ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m30[0m:[93m20[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m30[0m       expect(cache.clear).toBeDefined();
    [7m  [0m [91m                   ~~~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m31[0m:[93m27[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m31[0m       expect(typeof cache.clear).toBe('function');
    [7m  [0m [91m                          ~~~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m38[0m:[93m43[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m38[0m       await cache.set(testKey, testValue, 60);
    [7m  [0m [91m                                          ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m44[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m44[0m       await cache.del(testKey);
    [7m  [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m56[0m:[93m46[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m56[0m       await cache.set(testKey, complexValue, 60);
    [7m  [0m [91m                                             ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m62[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m62[0m       await cache.del(testKey);
    [7m  [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m73[0m:[93m41[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m73[0m       await cache.set(testKey, 'value', 60);
    [7m  [0m [91m                                        ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m77[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m77[0m       await cache.del(testKey);
    [7m  [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m85[0m:[93m43[0m - [91merror[0m[90m TS2559: [0mType '1' has no properties in common with type 'CacheOptions'.

    [7m85[0m       await cache.set(testKey, 'expires', 1);
    [7m  [0m [91m                                          ~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m99[0m:[93m42[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m99[0m       await cache.set(keys[0], 'value1', 60);
    [7m  [0m [91m                                         ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m100[0m:[93m42[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m100[0m       await cache.set(keys[1], 'value2', 60);
    [7m   [0m [91m                                         ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m101[0m:[93m42[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m101[0m       await cache.set(keys[2], 'value3', 60);
    [7m   [0m [91m                                         ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m112[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m112[0m       await cache.del(keys[0]);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m113[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m113[0m       await cache.del(keys[1]);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m114[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m114[0m       await cache.del(keys[2]);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m120[0m:[93m36[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m120[0m       await cache.set(testKey, '', 60);
    [7m   [0m [91m                                   ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m126[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m126[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m132[0m:[93m39[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m132[0m       await cache.set(testKey, 12345, 60);
    [7m   [0m [91m                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m138[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m138[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m145[0m:[93m39[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m145[0m       await cache.set(testKey1, true, 60);
    [7m   [0m [91m                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m146[0m:[93m40[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m146[0m       await cache.set(testKey2, false, 60);
    [7m   [0m [91m                                       ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m155[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m155[0m       await cache.del(testKey1);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m156[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m156[0m       await cache.del(testKey2);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m163[0m:[93m44[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m163[0m       await cache.set(testKey, arrayValue, 60);
    [7m   [0m [91m                                           ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m169[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m169[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m210[0m:[93m43[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m210[0m       await cache.set(testKey, testValue, 60);
    [7m   [0m [91m                                          ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m216[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m216[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m224[0m:[93m44[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m224[0m       await cache.set(testKey, 'isolated', 60);
    [7m   [0m [91m                                           ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m230[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m230[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m238[0m:[93m78[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m238[0m         operations.push(cache.set(`test:cache:concurrent:${i}`, `value${i}`, 60));
    [7m   [0m [91m                                                                             ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m252[0m:[93m31[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m252[0m         cleanupOps.push(cache.del(`test:cache:concurrent:${i}`));
    [7m   [0m [91m                              ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m259[0m:[93m52[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m259[0m       await cache.set(testKey, 'concurrent value', 60);
    [7m   [0m [91m                                                   ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m273[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m273[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m280[0m:[93m45[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m280[0m         cache.set(`${baseKey}:1`, 'value1', 60),
    [7m   [0m [91m                                            ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m281[0m:[93m45[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m281[0m         cache.set(`${baseKey}:2`, 'value2', 60),
    [7m   [0m [91m                                            ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m283[0m:[93m45[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m283[0m         cache.set(`${baseKey}:3`, 'value3', 60),
    [7m   [0m [91m                                            ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m303[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m303[0m       await cache.del(`${baseKey}:1`);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m304[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m304[0m       await cache.del(`${baseKey}:2`);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m305[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m305[0m       await cache.del(`${baseKey}:3`);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m318[0m:[93m38[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m318[0m       await cache.set(testKey, null, 60);
    [7m   [0m [91m                                     ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m324[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m324[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m330[0m:[93m43[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m330[0m       await cache.set(testKey, undefined, 60);
    [7m   [0m [91m                                          ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m337[0m:[93m19[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m337[0m       await cache.del(testKey);
    [7m   [0m [91m                  ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m344[0m:[93m55[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m344[0m       await cache.set('test:cache:clear:1', 'value1', 60);
    [7m   [0m [91m                                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m345[0m:[93m55[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m345[0m       await cache.set('test:cache:clear:2', 'value2', 60);
    [7m   [0m [91m                                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m346[0m:[93m55[0m - [91merror[0m[90m TS2559: [0mType '60' has no properties in common with type 'CacheOptions'.

    [7m346[0m       await cache.set('test:cache:clear:3', 'value3', 60);
    [7m   [0m [91m                                                      ~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m349[0m:[93m17[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m349[0m       if (cache.clear) {
    [7m   [0m [91m                ~~~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m350[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'clear' does not exist on type 'CacheService'.

    [7m350[0m         await cache.clear('test:cache:clear:*');
    [7m   [0m [91m                    ~~~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m353[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m353[0m         await cache.del('test:cache:clear:1');
    [7m   [0m [91m                    ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m354[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m354[0m         await cache.del('test:cache:clear:2');
    [7m   [0m [91m                    ~~~[0m
    [96mtests/integration/cache-integration.test.ts[0m:[93m355[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'del' does not exist on type 'CacheService'.

    [7m355[0m         await cache.del('test:cache:clear:3');
    [7m   [0m [91m                    ~~~[0m

FAIL tests/integration/async-handler.util.test.ts
  ● Test suite failed to run

    [96mtests/integration/async-handler.util.test.ts[0m:[93m23[0m:[93m62[0m - [91merror[0m[90m TS2345: [0mArgument of type '(code?: number) => never' is not assignable to parameter of type '(code?: string | number | null | undefined) => never'.
      Types of parameters 'code' and 'code' are incompatible.
        Type 'string | number | null | undefined' is not assignable to type 'number | undefined'.
          Type 'null' is not assignable to type 'number | undefined'.

    [7m23[0m     exitSpy = jest.spyOn(process, 'exit').mockImplementation((code?: number) => {
    [7m  [0m [91m                                                             ~~~~~~~~~~~~~~~~~~~~[0m

FAIL tests/integration/Transfer.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Transfer.model.test.ts[0m:[93m18[0m:[93m39[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m18[0m     transferModel = new TransferModel(DatabaseService.pool);
    [7m  [0m [91m                                      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Transfer.model.test.ts[0m:[93m18[0m:[93m55[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m18[0m     transferModel = new TransferModel(DatabaseService.pool);
    [7m  [0m [91m                                                      ~~~~[0m

FAIL tests/integration/Ticket.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Ticket.model.test.ts[0m:[93m18[0m:[93m35[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m18[0m     ticketModel = new TicketModel(DatabaseService.pool);
    [7m  [0m [91m                                  ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Ticket.model.test.ts[0m:[93m18[0m:[93m51[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m18[0m     ticketModel = new TicketModel(DatabaseService.pool);
    [7m  [0m [91m                                                  ~~~~[0m

FAIL tests/integration/Reservation.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Reservation.model.test.ts[0m:[93m19[0m:[93m45[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m19[0m     reservationModel = new ReservationModel(DatabaseService.pool);
    [7m  [0m [91m                                            ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Reservation.model.test.ts[0m:[93m19[0m:[93m61[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m19[0m     reservationModel = new ReservationModel(DatabaseService.pool);
    [7m  [0m [91m                                                            ~~~~[0m
    [96mtests/integration/Reservation.model.test.ts[0m:[93m238[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m238[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'
    [96mtests/integration/Reservation.model.test.ts[0m:[93m251[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m251[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'
    [96mtests/integration/Reservation.model.test.ts[0m:[93m280[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m280[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'
    [96mtests/integration/Reservation.model.test.ts[0m:[93m403[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m403[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'
    [96mtests/integration/Reservation.model.test.ts[0m:[93m416[0m:[93m9[0m - [91merror[0m[90m TS2322: [0mType '"active"' is not assignable to type '"pending" | "confirmed" | "expired" | "cancelled"'.

    [7m416[0m         status: 'active',
    [7m   [0m [91m        ~~~~~~[0m

      [96msrc/models/Reservation.ts[0m:[93m13[0m:[93m3[0m
        [7m13[0m   status: 'pending' | 'confirmed' | 'expired' | 'cancelled';
        [7m  [0m [96m  ~~~~~~[0m
        The expected type comes from property 'status' which is declared here on type 'IReservation'

FAIL tests/integration/QRCode.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/QRCode.model.test.ts[0m:[93m17[0m:[93m35[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m17[0m     qrCodeModel = new QRCodeModel(DatabaseService.pool);
    [7m  [0m [91m                                  ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/QRCode.model.test.ts[0m:[93m17[0m:[93m51[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m17[0m     qrCodeModel = new QRCodeModel(DatabaseService.pool);
    [7m  [0m [91m                                                  ~~~~[0m

FAIL tests/integration/Order.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Order.model.test.ts[0m:[93m17[0m:[93m33[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m17[0m     orderModel = new OrderModel(DatabaseService.pool);
    [7m  [0m [91m                                ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Order.model.test.ts[0m:[93m17[0m:[93m49[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m17[0m     orderModel = new OrderModel(DatabaseService.pool);
    [7m  [0m [91m                                                ~~~~[0m

FAIL tests/integration/Purchase.model.test.ts
  ● Test suite failed to run

    [96mtests/integration/Purchase.model.test.ts[0m:[93m18[0m:[93m39[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Pool | null' is not assignable to parameter of type 'Pool'.
      Type 'null' is not assignable to type 'Pool'.

    [7m18[0m     purchaseModel = new PurchaseModel(DatabaseService.pool);
    [7m  [0m [91m                                      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/integration/Purchase.model.test.ts[0m:[93m18[0m:[93m55[0m - [91merror[0m[90m TS2341: [0mProperty 'pool' is private and only accessible within class 'DatabaseServiceClass'.

    [7m18[0m     purchaseModel = new PurchaseModel(DatabaseService.pool);
    [7m  [0m [91m                                                      ~~~~[0m

FAIL tests/integration/queue.service.test.ts (35.112 s)
  ● QueueService Integration Tests › initialization › should emit connected event on successful connection

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      21 |     });
      22 |
    > 23 |     it('should emit connected event on successful connection', (done) => {
         |     ^
      24 |       QueueService.once('connected', () => {
      25 |         done();
      26 |       });

      at tests/integration/queue.service.test.ts:23:5
      at tests/integration/queue.service.test.ts:18:3
      at Object.<anonymous> (tests/integration/queue.service.test.ts:9:1)

  ● QueueService Integration Tests › consume operations › should consume messages from queue

    Operation failed: BasicConsume; 404 (NOT-FOUND) with message "NOT_FOUND - no queue 'test-consume-queue' in vhost '/'"

      at reply (node_modules/amqplib/lib/channel.js:141:31)
      at Channel.accept (node_modules/amqplib/lib/channel.js:319:9)
      at Connection.mainAccept (node_modules/amqplib/lib/connection.js:579:33)
      at Socket.go (node_modules/amqplib/lib/connection.js:431:16)

  ● QueueService Integration Tests › consume operations › should handle message processing errors

    IllegalOperationError: Channel closed

      109 |     }
      110 |
    > 111 |     await this.consumeChannel.prefetch(1);
          |                               ^
      112 |
      113 |     await this.consumeChannel.consume(queue, async (msg: any) => {
      114 |       if (!msg) return;

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel._rpc (node_modules/amqplib/lib/channel.js:149:10)
      at node_modules/amqplib/lib/channel_model.js:63:19
      at Channel.rpc (node_modules/amqplib/lib/channel_model.js:64:7)
      at Channel.qos (node_modules/amqplib/lib/channel_model.js:250:17)
      at QueueServiceClass.consume (src/services/queueService.ts:111:31)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:113:26)

  ● QueueService Integration Tests › consume operations › should acknowledge successful message processing

    IllegalOperationError: Channel closed

      109 |     }
      110 |
    > 111 |     await this.consumeChannel.prefetch(1);
          |                               ^
      112 |
      113 |     await this.consumeChannel.consume(queue, async (msg: any) => {
      114 |       if (!msg) return;

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel._rpc (node_modules/amqplib/lib/channel.js:149:10)
      at node_modules/amqplib/lib/channel_model.js:63:19
      at Channel.rpc (node_modules/amqplib/lib/channel_model.js:64:7)
      at Channel.qos (node_modules/amqplib/lib/channel_model.js:250:17)
      at QueueServiceClass.consume (src/services/queueService.ts:111:31)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:130:26)

  ● QueueService Integration Tests › message serialization › should handle JSON serialization

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:153:26)

  ● QueueService Integration Tests › message serialization › should handle special characters in messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:170:26)

  ● QueueService Integration Tests › message serialization › should handle unicode in messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:187:26)

  ● QueueService Integration Tests › queue durability › should create durable queues

    expect(received).resolves.not.toThrow()

    Received promise rejected instead of resolved
    Rejected to value: [IllegalOperationError: Channel closed]

      201 |     it('should create durable queues', async () => {
      202 |       // Publishing to configured queues should work (they're durable)
    > 203 |       await expect(
          |             ^
      204 |         QueueService.publish(config.rabbitmq.queues.ticketEvents, {
      205 |           type: 'DURABLE_TEST'
      206 |         })

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:203:13)

  ● QueueService Integration Tests › queue durability › should persist messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:216:26)

  ● QueueService Integration Tests › concurrent operations › should handle multiple concurrent publishes

    expect(received).resolves.not.toThrow()

    Received promise rejected instead of resolved
    Rejected to value: [IllegalOperationError: Channel closed]

      236 |       }
      237 |
    > 238 |       await expect(Promise.all(promises)).resolves.not.toThrow();
          |             ^
      239 |     });
      240 |
      241 |     it('should process multiple messages sequentially', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:238:13)

  ● QueueService Integration Tests › concurrent operations › should process multiple messages sequentially

    IllegalOperationError: Channel closed

      109 |     }
      110 |
    > 111 |     await this.consumeChannel.prefetch(1);
          |                               ^
      112 |
      113 |     await this.consumeChannel.consume(queue, async (msg: any) => {
      114 |       if (!msg) return;

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel._rpc (node_modules/amqplib/lib/channel.js:149:10)
      at node_modules/amqplib/lib/channel_model.js:63:19
      at Channel.rpc (node_modules/amqplib/lib/channel_model.js:64:7)
      at Channel.qos (node_modules/amqplib/lib/channel_model.js:250:17)
      at QueueServiceClass.consume (src/services/queueService.ts:111:31)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:245:26)

  ● QueueService Integration Tests › connection status › should handle graceful shutdown

    expect(received).resolves.not.toThrow()

    Received promise rejected instead of resolved
    Rejected to value: [IllegalOperationError: Channel closed]

      266 |     it('should handle graceful shutdown', async () => {
      267 |       // Service should close without errors
    > 268 |       await expect(QueueService.close()).resolves.not.toThrow();
          |             ^
      269 |
      270 |       expect(QueueService.isConnected()).toBe(false);
      271 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:268:13)

  ● QueueService Integration Tests › error handling › should handle publishing when not initialized

    IllegalOperationError: Channel closed

      138 |
      139 |     if (this.publishChannel) {
    > 140 |       await this.publishChannel.close();
          |                                 ^
      141 |     }
      142 |
      143 |     if (this.consumeChannel) {

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.closeBecause (node_modules/amqplib/lib/channel.js:198:10)
      at node_modules/amqplib/lib/channel_model.js:78:19
      at Channel.close (node_modules/amqplib/lib/channel_model.js:80:7)
      at QueueServiceClass.close (src/services/queueService.ts:140:33)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:279:26)

  ● QueueService Integration Tests › error handling › should handle invalid queue names gracefully

    expect(received).resolves.not.toThrow()

    Received promise rejected instead of resolved
    Rejected to value: [IllegalOperationError: Channel closed]

      290 |     it('should handle invalid queue names gracefully', async () => {
      291 |       // RabbitMQ accepts most queue names
    > 292 |       await expect(
          |             ^
      293 |         QueueService.publish('test.queue.name', { type: 'TEST' })
      294 |       ).resolves.not.toThrow();
      295 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:292:13)

  ● QueueService Integration Tests › message types › should handle ticket events

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:306:26)

  ● QueueService Integration Tests › message types › should handle NFT minting requests

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:319:26)

  ● QueueService Integration Tests › message types › should handle notification messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:332:26)

  ● QueueService Integration Tests › message validation › should publish empty objects

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:341:26)

  ● QueueService Integration Tests › message validation › should handle large messages

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:350:26)

  ● QueueService Integration Tests › message validation › should handle messages with dates

    IllegalOperationError: Channel closed

      92 |
      93 |     try {
    > 94 |       const sent = this.publishChannel.sendToQueue(queue, messageBuffer, { persistent: true });
         |                                        ^
      95 |
      96 |       if (!sent) {
      97 |         this.log.warn('Message was not sent, queue buffer full', { queue });

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.publish (node_modules/amqplib/lib/channel_model.js:158:17)
      at Channel.sendToQueue (node_modules/amqplib/lib/channel_model.js:162:17)
      at QueueServiceClass.publish (src/services/queueService.ts:94:40)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:359:26)

  ● QueueService Integration Tests › consumer patterns › should support multiple consumers on same queue

    IllegalOperationError: Channel closed

      109 |     }
      110 |
    > 111 |     await this.consumeChannel.prefetch(1);
          |                               ^
      112 |
      113 |     await this.consumeChannel.consume(queue, async (msg: any) => {
      114 |       if (!msg) return;

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel._rpc (node_modules/amqplib/lib/channel.js:149:10)
      at node_modules/amqplib/lib/channel_model.js:63:19
      at Channel.rpc (node_modules/amqplib/lib/channel_model.js:64:7)
      at Channel.qos (node_modules/amqplib/lib/channel_model.js:250:17)
      at QueueServiceClass.consume (src/services/queueService.ts:111:31)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:378:26)


  ● Test suite failed to run

    IllegalOperationError: Channel closed

      138 |
      139 |     if (this.publishChannel) {
    > 140 |       await this.publishChannel.close();
          |                                 ^
      141 |     }
      142 |
      143 |     if (this.consumeChannel) {

      at Channel.<anonymous> (node_modules/amqplib/lib/channel.js:373:11)
      at Channel.closeBecause (node_modules/amqplib/lib/channel.js:198:10)
      at node_modules/amqplib/lib/channel_model.js:78:19
      at Channel.close (node_modules/amqplib/lib/channel_model.js:80:7)
      at QueueServiceClass.close (src/services/queueService.ts:140:33)
      at Object.<anonymous> (tests/integration/queue.service.test.ts:15:24)


Test Suites: 29 failed, 11 passed, 40 total
Tests:       348 failed, 410 passed, 758 total
Snapshots:   0 total
Time:        36.954 s
Ran all test suites matching /tests\/integration\//i.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
