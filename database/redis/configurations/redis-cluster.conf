# redis-cluster.conf - TicketToken Redis Cluster Configuration
# Step 1: Single node that works
# Generated on: Sat Jul 19 11:40:55 EDT 2025

# Basic cluster node configuration
dir ./
cluster-enabled yes
cluster-config-file nodes-7000.conf

# Test with: redis-server database/redis/configurations/redis-cluster.conf

# =====================================================================
# STEP 2: CLUSTER SETTINGS
# Add timeout, replication, and failover configuration
# =====================================================================

# Cluster node timeout (milliseconds)
# Time a node must be unreachable to be considered failed
cluster-node-timeout 15000

# Cluster replica validity factor
# Replicas migrate to orphaned masters only if their max lag is <= this factor * node-timeout
cluster-replica-validity-factor 10

# Cluster migration barrier
# Minimum replicas a master must have to allow replica migration
cluster-migration-barrier 1

# Cluster require full coverage
# Set to no to allow cluster to serve queries with partial key coverage
cluster-require-full-coverage yes

# Cluster replica no failover
# Set to yes to disable automatic failover for this node
cluster-replica-no-failover no

# Additional settings from main Redis config
bind 127.0.0.1
protected-mode yes
daemonize no
pidfile /var/run/redis_7000.pid
loglevel notice
logfile ""

# Test cluster commands:
# redis-cli -p 7000 cluster info
# redis-cli -p 7000 cluster nodes

# =====================================================================
# STEP 3: MULTI-NODE TEMPLATE
# Template for 6-node cluster (3 masters, 3 replicas)
# =====================================================================

# To create a 6-node cluster, create 6 config files:
# redis-7000.conf, redis-7001.conf, ..., redis-7005.conf
# Each with unique:
# - port (7000-7005)
# - pidfile (/var/run/redis_700X.pid)
# - cluster-config-file (nodes-700X.conf)
# - dir (./700X/)

# Example node configurations:
# Node 1 (Master): port 7000
# Node 2 (Master): port 7001  
# Node 3 (Master): port 7002
# Node 4 (Replica): port 7003
# Node 5 (Replica): port 7004
# Node 6 (Replica): port 7005

# Cluster announce settings (for Docker/NAT environments)
# cluster-announce-ip 10.1.1.5
# cluster-announce-port 7000
# cluster-announce-bus-port 17000

# Performance settings for cluster
tcp-backlog 511
tcp-keepalive 60
maxclients 10000

# Memory and persistence (same as main Redis)
maxmemory 1gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
appendonly yes

# Security (inherit from main config)
# requirepass TicketToken2025SecurePass!
# masterauth TicketToken2025SecurePass!

# =====================================================================
# CLUSTER CREATION COMMANDS
# =====================================================================

# 1. Start all 6 nodes:
# redis-server redis-7000.conf
# redis-server redis-7001.conf
# redis-server redis-7002.conf
# redis-server redis-7003.conf
# redis-server redis-7004.conf
# redis-server redis-7005.conf

# 2. Create the cluster:
# redis-cli --cluster create \
#   127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
#   127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 \
#   --cluster-replicas 1

# 3. Check cluster status:
# redis-cli -p 7000 cluster info
# redis-cli -p 7000 cluster nodes

# 4. Test sharding:
# redis-cli -c -p 7000 set foo bar
# redis-cli -c -p 7000 get foo
