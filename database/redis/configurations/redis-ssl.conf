# Redis SSL/TLS Configuration for TicketToken Platform
# Phase 1: Minimal TLS Configuration

# Disable non-TLS port
port 0

# Enable TLS port
tls-port 6380

# TLS is now listening on port 6380

# ============================================
# PHASE 2: CERTIFICATE CONFIGURATION
# ============================================

# Certificate and key files (paths for production)
tls-cert-file /etc/redis/tls/redis.crt
tls-key-file /etc/redis/tls/redis.key

# Certificate Authority (for verifying clients)
tls-ca-cert-file /etc/redis/tls/ca.crt

# DH parameters file (optional but recommended)
tls-dh-params-file /etc/redis/tls/redis.dh

# Require client certificates (mutual TLS)
tls-auth-clients yes

# For self-signed cert generation:
# openssl req -x509 -nodes -newkey rsa:4096 -keyout redis.key -out redis.crt -days 365

# ============================================
# PHASE 3: ADVANCED SECURITY SETTINGS
# ============================================

# TLS protocol versions (only allow secure versions)
tls-protocols "TLSv1.2 TLSv1.3"

# Cipher suites (strong ciphers only)
tls-ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256

# Prefer server cipher order
tls-prefer-server-ciphers yes

# Session caching to improve TLS performance
tls-session-caching yes
tls-session-cache-timeout 300

# Replication over TLS
tls-replication yes

# Cluster communication over TLS (if using cluster)
tls-cluster yes

# ============================================
# PHASE 4: CERTIFICATE GENERATION & TESTING
# ============================================

# GENERATE SELF-SIGNED CERTIFICATES FOR TESTING:
# 
# 1. Create directory:
#    sudo mkdir -p /etc/redis/tls
#
# 2. Generate CA key and certificate:
#    openssl genrsa -out ca.key 4096
#    openssl req -x509 -new -nodes -key ca.key -days 3650 -out ca.crt
#
# 3. Generate server key and certificate:
#    openssl genrsa -out redis.key 4096
#    openssl req -new -key redis.key -out redis.csr
#    openssl x509 -req -in redis.csr -CA ca.crt -CAkey ca.key -CAcreateserial -days 365 -out redis.crt
#
# 4. Generate DH parameters:
#    openssl dhparam -out redis.dh 2048
#
# 5. Set permissions:
#    sudo chown redis:redis /etc/redis/tls/*
#    sudo chmod 600 /etc/redis/tls/redis.key

# ============================================
# TESTING COMMANDS
# ============================================
#
# Test TLS connection:
#   redis-cli --tls --cert redis.crt --key redis.key --cacert ca.crt -p 6380 ping
#
# Test without client cert (will fail if tls-auth-clients=yes):
#   redis-cli --tls --cacert ca.crt -p 6380 ping
#
# Verify TLS is working:
#   openssl s_client -connect localhost:6380 -cert redis.crt -key redis.key -CAfile ca.crt
