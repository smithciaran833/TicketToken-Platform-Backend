# redis.conf - TicketToken Redis Configuration
# Phase 1: Minimal working config (MUST START)
# Generated on: Sat Jul 19 11:23:45 EDT 2025

# Basic Redis configuration that will definitely start
port 6379
bind 127.0.0.1
protected-mode yes

# Test with: redis-server database/redis/configurations/redis.conf

# =====================================================================
# PHASE 2: MEMORY AND PERSISTENCE
# Add memory management and data persistence
# =====================================================================

# Memory Management
# Set max memory to 2GB (adjust based on your server)
maxmemory 2gb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# RDB Persistence (Snapshots)
# Save after 900 sec (15 min) if at least 1 key changed
save 900 1
# Save after 300 sec (5 min) if at least 10 keys changed
save 300 10
# Save after 60 sec if at least 10000 keys changed
save 60 10000

# RDB Configuration
dbfilename dump.rdb
dir ./

# AOF Persistence (Append Only File)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Test persistence with:
# redis-cli SET test:key "test_value"
# redis-cli BGSAVE
# redis-cli INFO persistence

# =====================================================================
# PHASE 3: PERFORMANCE TUNING
# Optimize Redis for production workloads
# =====================================================================

# TCP Listen Settings
tcp-backlog 511
tcp-keepalive 300
timeout 0

# Client Connection Handling
maxclients 10000

# Client Output Buffer Limits
# normal -> normal clients
# replica -> replica clients
# pubsub -> clients subscribed to channels
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Threading and I/O
# Enable I/O threading for better performance on multi-core systems
io-threads 4
io-threads-do-reads yes

# Slow Log Configuration
slowlog-log-slower-than 10000
slowlog-max-len 128

# Advanced Configuration
hz 10
dynamic-hz yes

# Disable potentially expensive commands
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG ""

# Test performance with:
# redis-benchmark -q -n 100000
# redis-cli --latency
# redis-cli INFO stats

# =====================================================================
# PHASE 4: SECURITY CONFIGURATION
# Secure Redis for production use
# =====================================================================

# Basic Security
# IMPORTANT: Change this password in production!
requirepass TicketToken2025SecurePass!

# ACL Configuration (Redis 6.0+)
# Load ACL rules from external file
aclfile /home/kevin/tickettoken-platform/database/redis/configurations/users.acl

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS "KEYS_DISABLED_USE_SCAN"
rename-command CONFIG "CONFIG_DISABLED_FOR_SECURITY"
rename-command SHUTDOWN "SHUTDOWN_DISABLED"

# TLS/SSL Configuration (Optional - uncomment to enable)
# port 0
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt
# tls-dh-params-file /path/to/dhparams.pem
# tls-protocols "TLSv1.2 TLSv1.3"
# tls-ciphers "HIGH:!aNULL:!MD5"
# tls-prefer-server-ciphers yes

# Additional Security Settings
# Disable potentially dangerous commands in transactions
# disable-thp yes

# Test security with:
# redis-cli -a TicketToken2025SecurePass! ping
# redis-cli -a TicketToken2025SecurePass! ACL LIST
# redis-cli -a TicketToken2025SecurePass! CONFIG GET requirepass
