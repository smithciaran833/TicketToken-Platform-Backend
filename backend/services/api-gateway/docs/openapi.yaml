openapi: 3.0.3
info:
  title: TicketToken API Gateway
  description: |
    # TicketToken API Gateway
    
    The API Gateway provides a unified entry point for all TicketToken platform services.
    
    ## Features
    - Multi-tenant isolation
    - JWT-based authentication
    - Circuit breakers for all downstream services
    - Rate limiting and DDoS protection
    - Comprehensive monitoring and observability
    
    ## Authentication
    All protected endpoints require a valid JWT token in the Authorization header:
    ```
    Authorization: Bearer <jwt_token>
    ```
    
    ## Rate Limiting
    - 100 requests per minute per IP/tenant
    - 429 status code returned when exceeded
    
    ## Error Handling
    Standard error response format:
    ```json
    {
      "error": "Error message",
      "code": "ERROR_CODE",
      "statusCode": 400
    }
    ```
  version: 1.0.0
  contact:
    name: TicketToken API Support
    email: api-support@tickettoken.com
  license:
    name: Proprietary

servers:
  - url: https://api.tickettoken.com
    description: Production server
  - url: https://staging-api.tickettoken.com
    description: Staging server
  - url: http://localhost:3000
    description: Development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Venues
    description: Venue management operations
  - name: Events
    description: Event browsing and management
  - name: Tickets
    description: Ticket purchasing and management
  - name: Metrics
    description: Observability and monitoring

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from authentication service
  
  schemas:
    Error:
      type: object
      required:
        - error
        - code
        - statusCode
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
        statusCode:
          type: integer
          description: HTTP status code
      example:
        error: "Unauthorized access"
        code: "UNAUTHORIZED"
        statusCode: 401
    
    Venue:
      type: object
      required:
        - id
        - name
        - tenantId
      properties:
        id:
          type: string
          format: uuid
          description: Unique venue identifier
        name:
          type: string
          description: Venue name
        tenantId:
          type: string
          description: Tenant identifier
        address:
          type: string
          description: Physical address
        capacity:
          type: integer
          description: Total capacity
        description:
          type: string
          description: Venue description
        amenities:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      example:
        id: "550e8400-e29b-41d4-a716-446655440000"
        name: "Madison Square Garden"
        tenantId: "tenant-stadium-a"
        address: "4 Pennsylvania Plaza, New York, NY 10001"
        capacity: 20000
        description: "World's most famous arena"
        amenities: ["parking", "wifi", "restaurants"]
        createdAt: "2025-01-15T10:00:00Z"
        updatedAt: "2025-01-15T10:00:00Z"
    
    Event:
      type: object
      required:
        - id
        - name
        - venueId
        - tenantId
        - startTime
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        venueId:
          type: string
          format: uuid
        tenantId:
          type: string
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        description:
          type: string
        pricing:
          type: object
          properties:
            currency:
              type: string
              example: "USD"
            tiers:
              type: array
              items:
                type: object
                properties:
                  name:
                    type: string
                  price:
                    type: number
                  available:
                    type: integer
        status:
          type: string
          enum: [draft, published, cancelled, completed]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      example:
        id: "660e8400-e29b-41d4-a716-446655440000"
        name: "Rock Concert 2025"
        venueId: "550e8400-e29b-41d4-a716-446655440000"
        tenantId: "tenant-stadium-a"
        startTime: "2025-06-15T20:00:00Z"
        endTime: "2025-06-15T23:00:00Z"
        description: "Amazing rock concert"
        pricing:
          currency: "USD"
          tiers:
            - name: "General Admission"
              price: 50.00
              available: 5000
            - name: "VIP"
              price: 150.00
              available: 500
        status: "published"
    
    Ticket:
      type: object
      required:
        - id
        - eventId
        - userId
        - status
      properties:
        id:
          type: string
          format: uuid
        eventId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        seatInfo:
          type: object
          properties:
            section:
              type: string
            row:
              type: string
            seat:
              type: string
        price:
          type: number
        status:
          type: string
          enum: [reserved, confirmed, used, cancelled]
        nftAddress:
          type: string
          description: Solana NFT address
        createdAt:
          type: string
          format: date-time
      example:
        id: "770e8400-e29b-41d4-a716-446655440000"
        eventId: "660e8400-e29b-41d4-a716-446655440000"
        userId: "880e8400-e29b-41d4-a716-446655440000"
        orderId: "990e8400-e29b-41d4-a716-446655440000"
        seatInfo:
          section: "A"
          row: "10"
          seat: "15"
        price: 50.00
        status: "confirmed"
        nftAddress: "7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU"
    
    HealthStatus:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        uptime:
          type: number
          description: Uptime in seconds
        version:
          type: string
        dependencies:
          type: object
          additionalProperties:
            type: object
            properties:
              status:
                type: string
                enum: [up, down]
              latency:
                type: number
        circuitBreakers:
          type: object
          additionalProperties:
            type: string
            enum: [closed, open, half-open]

paths:
  /health/live:
    get:
      tags:
        - Health
      summary: Liveness probe
      description: Returns 200 if service is alive (Kubernetes liveness probe)
      operationId: getLiveness
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  timestamp:
                    type: string
                    format: date-time
        '503':
          description: Service is not alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: Returns 200 if service is ready to accept traffic (Kubernetes readiness probe)
      operationId: getReadiness
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /metrics:
    get:
      tags:
        - Metrics
      summary: Prometheus metrics
      description: Returns Prometheus-format metrics for monitoring
      operationId: getMetrics
      responses:
        '200':
          description: Metrics in Prometheus format
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP http_requests_total Total HTTP requests
                  # TYPE http_requests_total counter
                  http_requests_total{method="GET",route="/api/v1/venues",status_code="200"} 1523
  
  /api/v1/venues:
    get:
      tags:
        - Venues
      summary: List venues
      description: Returns all venues accessible to the authenticated user's tenant
      operationId: listVenues
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of results
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of results to skip
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: search
          in: query
          description: Search query for venue name
          schema:
            type: string
      responses:
        '200':
          description: List of venues
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Venue'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                      limit:
                        type: integer
                      offset:
                        type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Service unavailable (circuit breaker open)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/v1/venues/{venueId}:
    get:
      tags:
        - Venues
      summary: Get venue details
      description: Returns detailed information about a specific venue
      operationId: getVenue
      security:
        - BearerAuth: []
      parameters:
        - name: venueId
          in: path
          required: true
          description: Venue ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Venue details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Venue'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (cross-tenant access)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Venue not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/v1/events:
    get:
      tags:
        - Events
      summary: List events
      description: Returns all events accessible to the authenticated user's tenant
      operationId: listEvents
      security:
        - BearerAuth: []
      parameters:
        - name: venueId
          in: query
          description: Filter by venue ID
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          description: Filter by event status
          schema:
            type: string
            enum: [draft, published, cancelled, completed]
        - name: startDate
          in: query
          description: Filter events starting after this date
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          description: Filter events ending before this date
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                      limit:
                        type: integer
                      offset:
                        type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /api/v1/events/{eventId}:
    get:
      tags:
        - Events
      summary: Get event details
      description: Returns detailed information about a specific event
      operationId: getEvent
      security:
        - BearerAuth: []
      parameters:
        - name: eventId
          in: path
          required: true
          description: Event ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Event details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Event'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (cross-tenant access)
        '404':
          description: Event not found
  
  /api/v1/tickets/purchase:
    post:
      tags:
        - Tickets
      summary: Purchase tickets
      description: |
        Purchase tickets for an event. This initiates the ticket purchase flow:
        1. Reserve tickets
        2. Process payment
        3. Mint NFT tickets
        4. Confirm purchase
      operationId: purchaseTickets
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - eventId
                - quantity
              properties:
                eventId:
                  type: string
                  format: uuid
                  description: Event to purchase tickets for
                quantity:
                  type: integer
                  minimum: 1
                  maximum: 10
                  description: Number of tickets to purchase
                seatSelection:
                  type: string
                  description: Seat preference (general, vip, etc.)
                paymentMethod:
                  type: object
                  description: Payment method details
      responses:
        '200':
          description: Purchase successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  orderId:
                    type: string
                    format: uuid
                  tickets:
                    type: array
                    items:
                      $ref: '#/components/schemas/Ticket'
                  totalPrice:
                    type: number
                  status:
                    type: string
                    enum: [processing, confirmed]
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
        '409':
          description: Tickets not available
        '422':
          description: Payment failed
  
  /api/v1/tickets:
    get:
      tags:
        - Tickets
      summary: List user tickets
      description: Returns all tickets owned by the authenticated user
      operationId: listTickets
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by ticket status
          schema:
            type: string
            enum: [reserved, confirmed, used, cancelled]
        - name: eventId
          in: query
          description: Filter by event ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of tickets
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Ticket'
        '401':
          description: Unauthorized
  
  /api/v1/tickets/{ticketId}:
    get:
      tags:
        - Tickets
      summary: Get ticket details
      description: Returns detailed information about a specific ticket
      operationId: getTicket
      security:
        - BearerAuth: []
      parameters:
        - name: ticketId
          in: path
          required: true
          description: Ticket ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Ticket details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Ticket'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not ticket owner)
        '404':
          description: Ticket not found

security:
  - BearerAuth: []
