import { Request, Response, NextFunction } from 'express';
import { createClient } from 'redis';
import crypto from 'crypto';
import { config } from '../config';

const redis = createClient({
  socket: {
    host: config.redis.host,
    port: config.redis.port
  }
});

redis.connect().catch(console.error);

export function idempotency() {
  return async (req: Request, res: Response, next: NextFunction) => {
    if (!req.headers['idempotency-key']) {
      return next();
    }

    const key = req.headers['idempotency-key'] as string;
    const cacheKey = `idempotency:${key}`;

    try {
      const cached = await redis.get(cacheKey);
      if (cached) {
        const result = JSON.parse(cached);
        return res.status(result.status).json(result.body);
      }

      const originalSend = res.json.bind(res);
      res.json = function(body: any) {
        redis.setEx(cacheKey, 3600, JSON.stringify({
          status: res.statusCode,
          body
        })).catch(console.error);
        return originalSend(body);
      };

      next();
    } catch (error) {
      console.error('Idempotency error:', error);
      next();
    }
  };
}
