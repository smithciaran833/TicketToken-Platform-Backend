# C4 Context Diagram - Venue Service

## Level 1: System Context

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              TICKETTOKEN PLATFORM                                │
└─────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────┐
                                    │    Fans     │
                                    │  (Users)    │
                                    └──────┬──────┘
                                           │
                                           ▼
                        ┌─────────────────────────────────────┐
                        │        API Gateway (Kong)           │
                        │   - Rate limiting                   │
                        │   - Authentication                  │
                        │   - Request routing                 │
                        └─────────────────┬───────────────────┘
                                          │
          ┌───────────────────────────────┼───────────────────────────────┐
          │                               │                               │
          ▼                               ▼                               ▼
┌─────────────────┐           ┌─────────────────────┐           ┌─────────────────┐
│  Auth Service   │           │   VENUE SERVICE     │           │  Event Service  │
│                 │◄─────────►│                     │◄─────────►│                 │
│ - JWT issuance  │           │ - Venue management  │           │ - Event CRUD    │
│ - User auth     │           │ - White-label       │           │ - Scheduling    │
│ - Permissions   │           │ - Integrations      │           │ - Capacity      │
└─────────────────┘           │ - Stripe Connect    │           └─────────────────┘
                              │ - Resale policies   │
                              └─────────┬───────────┘
                                        │
          ┌─────────────────────────────┼─────────────────────────────┐
          │                             │                             │
          ▼                             ▼                             ▼
┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐
│   PostgreSQL    │           │      Redis      │           │    MongoDB      │
│                 │           │                 │           │                 │
│ - Venues        │           │ - Cache         │           │ - Venue content │
│ - Settings      │           │ - Rate limits   │           │ - Reviews       │
│ - Integrations  │           │ - Locks         │           │ - Media         │
│ - Operations    │           │ - Sessions      │           │                 │
└─────────────────┘           └─────────────────┘           └─────────────────┘

                              ┌─────────────────┐
                              │  Stripe Connect │
                              │                 │
                              │ - Payments      │
                              │ - Payouts       │
                              │ - Webhooks      │
                              └─────────────────┘
```

## Level 2: Container Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              VENUE SERVICE                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌───────────────────────────────────────────────────────────────────────┐    │
│   │                         Fastify Application                            │    │
│   │                                                                        │    │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │    │
│   │  │   Routes     │  │  Middleware   │  │  Controllers │                │    │
│   │  │              │  │              │  │              │                │    │
│   │  │ - venues     │  │ - auth       │  │ - venues     │                │    │
│   │  │ - settings   │  │ - tenant     │  │ - settings   │                │    │
│   │  │ - stripe     │  │ - rate-limit │  │ - stripe     │                │    │
│   │  │ - branding   │  │ - idempotent │  │ - branding   │                │    │
│   │  │ - domains    │  │ - error      │  │ - domains    │                │    │
│   │  │ - health     │  │              │  │ - integrations│               │    │
│   │  └──────────────┘  └──────────────┘  └──────────────┘                │    │
│   │                                                                        │    │
│   │  ┌──────────────────────────────────────────────────────────────┐    │    │
│   │  │                         Services                              │    │    │
│   │  │                                                               │    │    │
│   │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐             │    │    │
│   │  │  │   Venue    │  │   Cache    │  │  Webhook   │             │    │    │
│   │  │  │  Service   │  │  Service   │  │  Service   │             │    │    │
│   │  │  └────────────┘  └────────────┘  └────────────┘             │    │    │
│   │  │                                                               │    │    │
│   │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐             │    │    │
│   │  │  │  Resale    │  │ Operations │  │  Stripe    │             │    │    │
│   │  │  │  Service   │  │  Service   │  │ Onboarding │             │    │    │
│   │  │  └────────────┘  └────────────┘  └────────────┘             │    │    │
│   │  │                                                               │    │    │
│   │  └──────────────────────────────────────────────────────────────┘    │    │
│   │                                                                        │    │
│   └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│   ┌───────────────────────────────────────────────────────────────────────┐    │
│   │                         Configuration                                  │    │
│   │                                                                        │    │
│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐     │    │
│   │  │  Database  │  │   Redis    │  │  MongoDB   │  │   Secrets  │     │    │
│   │  │   Config   │  │   Config   │  │   Config   │  │   Config   │     │    │
│   │  └────────────┘  └────────────┘  └────────────┘  └────────────┘     │    │
│   │                                                                        │    │
│   └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Level 3: Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           VENUE SERVICE COMPONENTS                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ API LAYER                                                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│  │ venues.routes   │    │ stripe.routes   │    │ health.routes   │            │
│  │                 │    │                 │    │                 │            │
│  │ GET  /venues    │    │ POST /connect   │    │ GET  /health    │            │
│  │ POST /venues    │    │ GET  /status    │    │ GET  /ready     │            │
│  │ PUT  /venues/:id│    │ POST /refresh   │    │ GET  /live      │            │
│  │ DEL  /venues/:id│    │ POST /webhook   │    │                 │            │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ MIDDLEWARE LAYER                                                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │     Auth     │  │    Tenant    │  │  Rate Limit  │  │  Idempotent  │       │
│  │  Middleware  │  │  Middleware  │  │  Middleware  │  │  Middleware  │       │
│  │              │  │              │  │              │  │              │       │
│  │ - JWT verify │  │ - RLS setup  │  │ - Redis      │  │ - Dedup      │       │
│  │ - User ctx   │  │ - Tenant ctx │  │ - Per-key    │  │ - Replay     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ SERVICE LAYER                                                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐ │
│  │    VenueService     │    │   WebhookService    │    │   ResaleService     │ │
│  │                     │    │                     │    │                     │ │
│  │ - CRUD operations   │    │ - Deduplication     │    │ - Jurisdiction      │ │
│  │ - Validation        │    │ - Distributed lock  │    │ - Price validation  │ │
│  │ - Search/filter     │    │ - Retry handling    │    │ - Transfer history  │ │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘ │
│                                                                                  │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐ │
│  │  OperationsService  │    │StripeOnboardService │    │    CacheService     │ │
│  │                     │    │                     │    │                     │ │
│  │ - Checkpoints       │    │ - Account creation  │    │ - Get/Set           │ │
│  │ - Resume            │    │ - Status tracking   │    │ - Invalidation      │ │
│  │ - Rollback          │    │ - Webhook handling  │    │ - TTL management    │ │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘ │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ DATA LAYER                                                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                           PostgreSQL (Primary)                            │  │
│  │                                                                           │  │
│  │  ┌─────────┐ ┌─────────────┐ ┌────────────────┐ ┌─────────────────────┐ │  │
│  │  │ venues  │ │venue_settings│ │venue_operations│ │ transfer_history   │ │  │
│  │  └─────────┘ └─────────────┘ └────────────────┘ └─────────────────────┘ │  │
│  │                                                                           │  │
│  │  ┌────────────────┐ ┌─────────────────┐ ┌────────────────────────────┐  │  │
│  │  │webhook_events  │ │ resale_policies │ │  seller_verifications      │  │  │
│  │  └────────────────┘ └─────────────────┘ └────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ┌─────────────────────┐                    ┌─────────────────────┐            │
│  │    Redis (Cache)    │                    │  MongoDB (Content)  │            │
│  │                     │                    │                     │            │
│  │  - Cache entries    │                    │  - Venue content    │            │
│  │  - Rate limit keys  │                    │  - Reviews          │            │
│  │  - Distributed locks│                    │  - Rich media       │            │
│  └─────────────────────┘                    └─────────────────────┘            │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## External Integrations

| Integration | Purpose | Protocol |
|-------------|---------|----------|
| Stripe Connect | Payment processing & payouts | REST + Webhooks |
| Auth Service | JWT verification | REST (internal) |
| Event Service | Event data | REST (internal) |
| RabbitMQ | Event publishing | AMQP |
| Prometheus | Metrics export | HTTP /metrics |

## Security Boundaries

- **Public Internet**: API Gateway only
- **Internal Network**: Service-to-service with mTLS
- **Database Network**: Isolated, VPC-only access
- **Redis/MongoDB**: Internal network, encrypted connections
